# RN çš„è§¦æ‘¸äº‹ä»¶å¤„ç†æœºåˆ¶

è§¦æ‘¸äº‹ä»¶æ˜¯ç”¨æˆ·ä¸å®¢æˆ·ç«¯ APP ä¸»è¦çš„äº¤äº’æ‰‹æ®µï¼Œæœ¬æ–‡æˆ‘ä»¬æ¥æ¢ç´¢ä¸€ä¸‹ RN æ˜¯å¦‚ä½•é€šè¿‡ç»„ä»¶æ¥å°è£…ä¸åŒå®¢æˆ·ç«¯çš„äº‹ä»¶å¤„ç†æœºåˆ¶

ä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä¸‹ Android ä¸ IOS çš„è§¦æ‘¸äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œè¿™æ ·æ‰èƒ½äº†è§£ RN åœ¨è®¾è®¡ä¹‹åˆçš„æƒè¡¡å–èˆ

## Android çš„äº‹ä»¶å¤„ç†æœºåˆ¶

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Android æ˜¯å¦‚ä½•æ³¨å†Œäº‹ä»¶å¤„ç†å›è°ƒçš„ï¼š

```java
public class ExampleActivity extends Activity implements OnClickListener {
    protected void onCreate(Bundle savedValues) {
        ...
        Button button = (Button)findViewById(R.id.corky);
      	// ç»™ button å…ƒç´ æ³¨å†Œç‚¹å‡»äº‹ä»¶çš„ç›‘å¬ï¼Œå¦‚æœ button è¢«ç‚¹å‡»ï¼Œå°±ä¼šè§¦å‘ä¼ å…¥å¯¹è±¡çš„ onClick æ–¹æ³•
        button.setOnClickListener(this);
    }

    public void onClick(View v) {
      // å¤„ç†ç‚¹å‡»äº‹ä»¶
    }
    ...
}
```

[setOnClickListener](https://developer.android.com/reference/android/view/View.OnClickListener) æ˜¯ Android ä¸­ View è¿™ä¸ªç±»çš„æ¥å£æ–¹æ³•ï¼Œå½“ç”¨æˆ·åœ¨å½“å‰ View è§¦å‘äº†ç‚¹å‡»äº‹ä»¶åï¼ŒAndroid å°±ä¼šä¸»åŠ¨è°ƒç”¨è¢«è¯¥æ–¹æ³•æ³¨å†Œçš„ onClick æ–¹æ³•

é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªæ–¹æ³•ä¼ é€’åˆ° js ä¾§å¤„ç†å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œä¸ªäººè®¤ä¸ºæœ‰å‡ ä¸ªåŸå› ï¼š

1. `setOnClickListener` æ˜¯ android å¹³å°å°è£…çš„æ–¹æ³•ï¼Œå®ƒæ²¡åŠæ³•ä¿è¯åœ¨å¤šå¹³å°ä¹‹é—´çš„ä¸€è‡´æ€§
2. æ²¡åŠæ³•å®šåˆ¶ä¸€äº›æ›´åŠ åŸå­åŒ–ï¼ˆä¾‹å¦‚ press-in/outï¼‰çš„è¡¨ç°
3. æ²¡åŠæ³•å®ç°/æ¨¡æ‹Ÿ JS çš„äº‹ä»¶æ•è·ä»¥åŠäº‹ä»¶å†’æ³¡

æ‰€ä»¥æˆ‘ä»¬éœ€è¦å†æ·±å…¥ä¸€æ­¥ï¼Œæ¢ç´¢ä¸€ä¸‹ Android çš„äº‹ä»¶æœ‰å“ªäº›ä»¥åŠæ˜¯å¦‚ä½•äº§ç”Ÿçš„

### Android çš„è§¦æ‘¸äº‹ä»¶

åœ¨ Android çš„[å¼€å‘è€…æ‰‹å†Œ](https://developer.android.com/develop/ui/views/touch-and-input/gestures/detector#capture-touch-events-for-an-activity-or-view)ä¸­ï¼Œå¸¸è§çš„è§¦æ‘¸äº‹ä»¶è¢«åˆ†æˆä»¥ä¸‹å‡ ç±»ï¼š

- `ACTION_DOWN`ï¼šå±å¹•æ£€æµ‹åˆ°æ‰‹æŒ‡æ”¾ä¸‹çš„äº‹ä»¶ï¼ˆä¸€æ¬¡è§¦æ‘¸åªä¼šæœ‰ä¸€ä¸ªï¼‰
- `ACTION_MOVE`ï¼šå±å¹•æ£€æµ‹åˆ°æ”¾ä¸‹çš„æ‰‹æŒ‡ç§»åŠ¨çš„äº‹ä»¶ï¼ˆä¸€èˆ¬æœ‰å¤šä¸ªï¼‰
- `ACTION_UP`ï¼šå±å¹•æ£€æµ‹åˆ°æ”¾ä¸‹çš„æ‰‹æŒ‡æŠ¬èµ·æ¥çš„äº‹ä»¶ï¼ˆä¸€æ¬¡è§¦æ‘¸æœ€å¤šåªä¼šæœ‰ä¸€ä¸ªï¼‰
- `ACTION_CANCEL`ï¼šè¡¨ç¤ºè¯¥è§¦æ‘¸äº‹ä»¶è¢«å–æ¶ˆäº†ï¼Œæ¯”å¦‚è¢«ä¸Šå±‚çš„ scroll view æ¥ç®¡äº†
- `ACTION_OUTSIDE`ï¼šè¡¨ç¤ºæ‰‹æŒ‡ç¦»å¼€äº†å½“å‰è§¦æ‘¸å…ƒç´ çš„èŒƒå›´

è¿™äº›äº‹ä»¶éƒ½è¢«å°è£…è¿›äº†ä¸€ä¸ª [MotionEvent](https://developer.android.com/reference/android/view/MotionEvent) ç±»

ä¸Šè¿°çš„äº‹ä»¶å¯ä»¥è¢«ç»„åˆæˆä¸€ä¸ªä¸ªè¯­ä¹‰åŒ–äº‹ä»¶ semantic eventsï¼Œæ¯”å¦‚ï¼š

- `click = ACTION_DOWN + [ACTION_MOVE] +  ACTION_UP`
- `longPress = ACTION_DOWN + hold 200ms + [ACTION_MOVE] + ACTION_UP`

åœ¨ RN ä¸­ï¼Œå°±æ˜¯é€šè¿‡æ¶ˆè´¹è¿™äº›è§¦æ‘¸äº‹ä»¶ï¼Œå¹¶ä¸”åœ¨ JS ä¾§è‡ªè¡Œç»„åˆæˆäº†ç»™å¼€å‘è€…æ¶ˆè´¹çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ onPressï¼‰

### Android çš„äº‹ä»¶å¤„ç†æµç¨‹

ä¸€èˆ¬æ¥è¯´ï¼ŒAndroid çš„äº‹ä»¶ä»ç¡¬ä»¶æ¥æ”¶åˆ°ä¿¡å·å¼€å§‹ï¼Œåˆ°æœ‰å¯¹åº”çš„ View æ¶ˆè´¹ç»“æŸä¼šç»è¿‡ä»¥ä¸‹å‡ æ­¥ï¼š

1. ç¡¬ä»¶å±‚ï¼šæ¥æ”¶åˆ°æ‰‹æŒ‡è§¦æ‘¸çš„ä¿¡å·ï¼Œç„¶åå°†åæ ‡ä¸äº‹ä»¶å‘é€ç»™æ“ä½œç³»ç»Ÿ
2. `InputManager`ï¼šAndroid ç³»ç»Ÿå±‚çš„ç±»ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­ï¼›ä¸»è¦è´Ÿè´£å°†åŸå§‹äº‹ä»¶å‘é€åˆ°å½“å‰ APP ä¸­
3. `InputChannel`ï¼šAndroid ç³»ç»Ÿä¸ APP æ²Ÿé€šçš„æ¡¥æ¢ï¼Œ`InputManager` å°±æ˜¯é€šè¿‡å®ƒæŠŠäº‹ä»¶å‘é€ç»™ APP çš„
4. `ViewRootImpl.WindowInputEventReceiver`ï¼šè¿è¡Œåœ¨æˆ‘ä»¬ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸­ï¼Œè´Ÿè´£æ¥å— `InputChannel` ä¸­çš„äº‹ä»¶
5. `ViewRootImpl.deliverInputEvent`ï¼šè´Ÿè´£åˆ†å‘ä¸åŒäº‹ä»¶åˆ°å„è‡ªçš„ handler æ‰‹ä¸Š
6. `ViewRootImpl.processPointerEvent`ï¼šè´Ÿè´£å¤„ç†è§¦æ‘¸äº‹ä»¶çš„ handlerï¼Œä»–ä¼šå°†äº‹ä»¶åŒ…è£…æˆ MotionEvent ç„¶åå°†å…¶æ´¾å‘åˆ°è§†å›¾æ ‘çš„æ ¹èŠ‚ç‚¹ä¸Š
7. `mView.dispatchTouchEvent`ï¼šmView æ˜¯æˆ‘ä»¬æ’å…¥è§†å›¾æ ‘çš„æ ¹ Viewï¼ˆåœ¨ RN çš„ä¾‹å­ä¸­æ˜¯ `ReactRootView`ï¼‰ï¼›å½“æˆ‘ä»¬çš„æ ¹èŠ‚ç‚¹æ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ä¹‹åï¼Œä»–ä¼šåˆ¤æ–­è‡ªå·±æ˜¯å¦è¦å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œå¦‚æœä¸å¤„ç†åˆ™ä¼šå‘ä»–ä¸‹é¢çš„èŠ‚ç‚¹è¿›è¡Œæ´¾å‘ï¼ˆæœ‰ç‚¹ç±»ä¼¼ JS çš„äº‹ä»¶æ•è·çš„è¿‡ç¨‹ï¼Œä½†ä¸å®Œå…¨ä¸€æ ·ï¼‰

ä»ç¬¬ä¸ƒæ­¥å¼€å§‹ï¼Œäº‹ä»¶ç»ˆäºè¿›å…¥äº†æˆ‘ä»¬èƒ½å¤Ÿç”¨ç¨‹åºæ§åˆ¶çš„èŒƒå›´äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­è®²è§£å‰©ä½™çš„äº‹ä»¶æ´¾å‘é€»è¾‘ï¼š

```jsx
ViewGroup (root)
 â”œâ”€ ViewA
 â”‚    â””â”€ ViewC   <-- finger is here
 â””â”€ ViewB
```

å‡è®¾å½“å‰æˆ‘ä»¬æœ‰ä¸€ä¸ªå æ®å…¨å±çš„ ViewGroupï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ªäº’ä¸é‡å çš„å…ƒç´  ViewA ä¸ ViewBï¼ŒViewA å…ƒç´ å†…éƒ¨è¿˜æœ‰ä¸€ä¸ª ViewC å…ƒç´ 

ç”¨æˆ·çš„è§¦æ‘¸äº‹ä»¶å‘ç”Ÿåœ¨ ViewC çš„èŒƒå›´å†…

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ†æˆä¸¤ç§æƒ…å†µè®¨è®ºï¼šViewC æ¶ˆè´¹äº†è§¦æ‘¸äº‹ä»¶ã€æ²¡æœ‰å…ƒç´ æ¶ˆè´¹è§¦æ‘¸äº‹ä»¶

#### ViewC æ¶ˆè´¹è§¦æ‘¸äº‹ä»¶

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ `ACTION_DOWN` äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œä»¥ä¸‹æ–¹æ³•ä¼šè¢«é€’å½’è°ƒç”¨ï¼š

```js
ViewGroup.dispatchTouchEvent(DOWN)
  â†’ ViewA.dispatchTouchEvent(DOWN)
    â†’ ViewC.dispatchTouchEvent(DOWN) // return true => ViewC becomes the target of the touch
```

åœ¨ `dispatchTouchEvent` ä¸­ï¼Œä¸»è¦å‘ç”Ÿäº†ä¸‰ä»¶äº‹ï¼š

1. è°ƒç”¨ [onInterceptTouchEvent](https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)) æ–¹æ³•åˆ¤æ–­æ˜¯å¦è¯¥äº‹ä»¶éœ€è¦è¢«å½“å‰å…ƒç´ æ‹¦æˆªï¼ˆåœ¨è¿™ä¸ªä¾‹å­é‡Œåªæœ‰ ViewC è¿”å›äº† trueï¼‰
2. å¦‚æœ  [onInterceptTouchEvent](https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)) è¿”å›äº† falseï¼Œåˆ™æ‰§è¡Œ hit-test æ ¹æ®å½“å‰äº‹ä»¶ä½ç½®åˆ¤æ–­åº”è¯¥è°ƒç”¨å“ªä¸€ä¸ªå­å…ƒç´ çš„ `dispatchTouchEvent` æ–¹æ³•ï¼ˆåŸåˆ™æ˜¯åœ¨å½“å‰ä½ç½®ä¸Šå±‚çº§æœ€é«˜çš„å­å…ƒç´ ä¼˜å…ˆè¢«è°ƒç”¨ï¼‰
3. å¦‚æœæœ‰å…ƒç´  [onInterceptTouchEvent](https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)) è¿”å›äº† trueï¼Œåˆ™ï¼š
   1. è°ƒç”¨è¯¥å…ƒç´ çš„ [onTouchEvent](https://developer.android.com/reference/android/view/View#onTouchEvent(android.view.MotionEvent)) æ–¹æ³•å¤„ç†è¯¥äº‹ä»¶
   2. çˆ¶å…ƒç´ æ ‡è®°å½“å‰å…ƒç´ ä¸ºè¯¥è§¦æ‘¸äº‹ä»¶çš„å¤„ç†å…ƒç´ ï¼ˆè¿™ä¸ªæ˜¯ä¸ºäº†å‡å°‘åç»­ `ACTION_UP` äº‹ä»¶çš„ hit-test å¼€é”€ï¼‰å°†å½“å‰çš„å¤„ç†å…ƒç´ æ ‡è®°åˆ° `mFirstTouchTarget` ä¸­

<br />

å½“ `ACTION_UP` äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œåˆ™æœ‰ï¼š

```js
ViewGroup.dispatchTouchEvent(UP)
  â†’ ViewA.dispatchTouchEvent(UP)
    â†’ ViewC.dispatchTouchEvent(UP) // call onTouchEvent(UP) => perform onClick
```

ç”±äºåœ¨ `ACTION_DOWN` çš„æ—¶å€™æ ‡è®°äº†å¤„ç†å…ƒç´ ï¼Œæ‰€ä»¥è¿™æ¬¡æ¯ä¸€ä¸ªå…ƒç´ åªéœ€è¦æ‰¾åˆ°å„è‡ªæ ‡è®°çš„ `mFirstTouchTarget`  ç„¶åç›´æ¥è°ƒç”¨å°±å¥½

åœ¨è¿™ä¸ªä¾‹å­ä¸­æœ€åä¼šç›´æ¥è§¦å‘ `ViewC.dispatchTouchEvent`ï¼Œæ‰§è¡Œåˆæˆä¹‹åçš„é«˜çº§äº‹ä»¶

#### æ²¡æœ‰å…ƒç´ æ¶ˆè´¹è§¦æ‘¸äº‹ä»¶

å¦‚æœæ²¡æœ‰å…ƒç´ è¦æ¶ˆè´¹è¿™ä¸ªäº‹ä»¶çš„è¯ï¼Œé€’å½’è°ƒç”¨å°±ä¼šå˜æˆï¼š

```js
ViewGroup.dispatchTouchEvent(DOWN)
  â†’ ViewA.dispatchTouchEvent(DOWN)
    â†’ ViewC.dispatchTouchEvent(DOWN)  // returns false (not clickable)
    â† back to ViewA â†’ ViewA.onTouchEvent(DOWN) â†’ false
  â† back to ViewGroup â†’ ViewGroup.onTouchEvent(DOWN) â†’ false
```

[onTouchEvent](https://developer.android.com/reference/android/view/View#onTouchEvent(android.view.MotionEvent)) é™¤äº†åœ¨å½“å‰å…ƒç´ çš„  [onInterceptTouchEvent](https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)) è¿”å› true æ—¶ä¼šæ‰§è¡Œï¼Œåœ¨å­å…ƒç´ ä¸æ¶ˆè´¹è¿™ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼Œä¹Ÿä¼šåœ¨å½’çš„æ—¶å€™è¢«è°ƒç”¨ï¼ˆå¯ä»¥æƒ³è±¡æˆäº‹ä»¶å¤„ç†æœºåˆ¶å¯¹è¯¥å…ƒç´ è¯´ï¼šå˜¿ï¼Œä½ çš„å­å…ƒç´ éƒ½ä¸å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œä½ è¦ä¸è¦å¤„ç†ä¸‹å…œä¸ªåº•å‘€ï¼Ÿï¼‰

å¦‚æœæ­¤æ—¶ `ViewA` è·Ÿ `ViewGroup` éƒ½è¿”å›äº† falseï¼Œåˆ™ä»£è¡¨æ²¡æœ‰å…ƒç´ æ„¿æ„æ¶ˆè´¹è¿™ä¸ªäº‹ä»¶ï¼Œè‡ªç„¶æ¯ä¸ªå…ƒç´ çš„ `mFirstTouchTarget` å°±éƒ½æ˜¯ç©ºçš„äº†

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ `ACTION_UP` äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œå½“äº‹ä»¶è¿›å…¥åˆ° `ViewGroup.dispatchTouchEvent` ä¼šå¾ˆå°´å°¬çš„å‘ç°ï¼Œ`mFirstTouchTarget` ä¸ºç©ºï¼Œæ²¡æœ‰å…ƒç´ æ„¿æ„æ¶ˆè´¹è‡ªå·±ï¼Œæ­¤æ—¶å®ƒä¼šæœ€åè°ƒç”¨ä¸€ä¸‹å½“å‰å…ƒç´ çš„ `onTouchEvent` ç„¶åå‘ç°è¿”å›äº† falseï¼Œäº‹ä»¶ç»ˆç»“

## IOS çš„äº‹ä»¶å¤„ç†æœºåˆ¶

IOS ä»ç¡¬ä»¶æ¥å—åˆ°ä¿¡å·åˆ°å¤„ç†äº‹ä»¶ä¸€èˆ¬ä¼šç»è¿‡ä»¥ä¸‹å‡ æ­¥ï¼š

1. å½“å±å¹•æ£€æµ‹åˆ°æ‰‹æŒ‡è§¦æ‘¸ï¼Œä¼šå°†å½“å‰äº‹ä»¶å‘é€åˆ°å½“å‰åº”ç”¨ä¸»çº¿ç¨‹çš„è¿è¡Œå¾ªç¯ï¼ˆmain run loopï¼‰ä¸­
2. UIKit ä¼šå°†äº‹ä»¶å°è£…æˆä¸€ä¸ª `UIEvent`ï¼Œä¸€ä¸ª `UIEvent` ä¸­ä¼šåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª `UITouch` å¯¹è±¡ï¼ˆå†…éƒ¨åŒ…å«æ­¤æ¬¡äº‹ä»¶çš„ä¿¡æ¯ï¼‰
3. IOS åº”ç”¨ä¼šä» `UIWindow`ï¼ˆé€šå¸¸åªä¼šæœ‰ä¸€ä¸ªï¼Œè´Ÿè´£æ‰¿è½½å½“å‰é¡µé¢æ‰€æœ‰ UIViewï¼‰ å¼€å§‹è¿›è¡Œ hit-testing æµç¨‹
4. Hit-testing ä¼šæ ¹æ®ä¸€ç³»åˆ—è§„åˆ™æ‰¾åˆ°éœ€è¦å¤„ç†è¯¥äº‹ä»¶çš„ View
5. `UIWindow` åŸºäºè¯¥ View å¼€å§‹ä¸€ç³»åˆ—çš„äº‹ä»¶å¤„ç†æœºåˆ¶

åœ¨æ­£å¼è¿›å…¥äº‹ä»¶å¤„ç†æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åŸç”Ÿ IOS åº”ç”¨å¯ä»¥å¦‚ä½•æ¶ˆè´¹äº‹ä»¶ï¼š

### UIResponder

UIResponder æ˜¯å‚ä¸ IOS äº‹ä»¶ä¼ é€’ç³»ç»Ÿçš„ä¸€ä¸ªåŸºç±»ï¼ŒUIView ç»§æ‰¿äº†è¿™ä¸ªåŸºç±»

åœ¨ UIResponder ä¸­æä¾›äº†ä¸€ç³»åˆ—**ä½é˜¶äº‹ä»¶å¤„ç†å›è°ƒ**

ç”±äº UIView ç»§æ‰¿äº†å®ƒï¼Œæ‰€ä»¥åœ¨ UIView ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡è½½ override è¿™äº›å›è°ƒæ¥æ‰§è¡Œæˆ‘ä»¬äº‹ä»¶å¤„ç†é€»è¾‘

æ¯”å¦‚ï¼š

```objc
@interface DraggableView : UIView
@end

@implementation DraggableView {
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
  // override with custom logic
}

- (void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
  // override with custom logic
}

- (void)touchesEnded:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
  // override with custom logic
}

- (void)touchesCancelled:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
  // override with custom logic
}
@end
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬é€šè¿‡é‡è½½äº† `touchesBegan`ï¼Œ `touchesMoved`ï¼Œ `touchesEnded`ï¼Œ `touchesCancelled` æ–¹æ³•å®šåˆ¶äº†è§¦æ‘¸äº‹ä»¶å‘ç”Ÿè¿‡ç¨‹çš„å¤„ç†é€»è¾‘

é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘½ä¸­ Hit-testing çš„ View é‡è½½çš„ `touchesXXX` äº‹ä»¶ä¼šè¢«ä¼˜å…ˆæ‰§è¡Œï¼Œå¦‚æœå½“å‰ View æ²¡æœ‰é‡è½½äº‹ä»¶æˆ–è€…åœ¨é‡è½½ä¸­è°ƒç”¨äº† `super touchesXXX:withEvent:` åˆ™è¯¥äº‹ä»¶å°†ä¼šç»§ç»­è¢«å…¶çˆ¶èŠ‚ç‚¹æ¶ˆè´¹

### UIControl

UIControl æ˜¯ UIView çš„å­ç±»ï¼ˆæ‰€ä»¥å®ƒä¹Ÿç»§æ‰¿äº† UIResponderï¼‰

ä¸ UIResponder ä¸åŒçš„æ˜¯ï¼ŒUIControl å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªçŠ¶æ€æœº state machineï¼Œç”¨æ¥**å°†å¤šä¸ªä½é˜¶çš„äº‹ä»¶å°è£…æˆé«˜é˜¶çš„è¯­ä¹‰åŒ–äº‹ä»¶**

ä»åº”ç”¨å¼€å‘è€…è§†è§’æ¥çœ‹ï¼ŒUIControl ä¸º Buttonã€Switches ç­‰å…ƒç´ æä¾›äº†ä¸€å¥—è¯­ä¹‰åŒ–äº‹ä»¶çš„æ¶ˆè´¹æ–¹å¼ï¼Œç®€åŒ–å¼€å‘è€…å¤„ç†å¸¸è§äº‹ä»¶çš„æµç¨‹

è¿™å¥—æ–¹å¼è¢«ç§°ä¹‹ä¸º **target-action**ï¼Œä»¥ä¸‹æ˜¯ä¾‹å­ï¼š

```objc
// åˆ›å»ºä¸€ä¸ª button 
UIButton *button = [UIButton buttonWithType:UIButtonTypeSystem];
// åœ¨è¿™ä¸ª button ä¸­æ³¨å†Œäº†ä¸€ä¸ªé’ˆå¯¹ UIControlEventTouchUpInside äº‹ä»¶çš„ç›‘å¬ï¼Œå¦‚æœè¯¥äº‹ä»¶è¢«è§¦å‘åˆ™æ‰§è¡Œ tapped æ–¹æ³•
[button addTarget:self action:@selector(tapped:) forControlEvents:UIControlEventTouchUpInside];

- (void)tapped:(UIButton *)sender {
  // handle button press
}
```

ç›¸æ¯” UIResponderï¼ŒUIControl å¼±åŒ–äº†å¼€å‘è€…å¯¹ touch ä½é˜¶äº‹ä»¶çš„æ„ŸçŸ¥ï¼Œåªéœ€è¦å¤„ç†é«˜é˜¶çš„è¯­ä¹‰åŒ–äº‹ä»¶å³å¯

### UIGestureRecognizer

[UIGestureRecognizer](https://developer.apple.com/documentation/uikit/uigesturerecognizer?language=objc) æ˜¯ IOS äº‹ä»¶å¤„ç†ä¸­ä¸€ä¸ª â€œå¦ç±»â€ çš„å¤„ç†æœºåˆ¶

å®ƒä¸åŒäº UIResponder ä¸ UIControl è¿™ç§åŸºäº View çš„äº‹ä»¶å“åº”é“¾æœºåˆ¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŸºäº â€œæ‰‹åŠ¿â€ çš„äº‹ä»¶å“åº”æœºåˆ¶

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆç”¨çš„ï¼Œå†æ¥èŠèŠå®ƒçš„æœºåˆ¶ï¼š

```objc
// åˆ›å»ºä¸€ä¸ªè¯†åˆ« tap æ‰‹åŠ¿çš„ GestureRecognizerï¼›å½“è¿™ä¸ªæ‰‹åŠ¿è¢«æˆåŠŸè¯†åˆ«è°ƒç”¨ didTap æ–¹æ³•å¤„ç†æ‰‹åŠ¿
UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self 		action:@selector(didTap:)];
tap.numberOfTapsRequired = 1;
// åœ¨å½“å‰ view ä¸Šæ³¨å†Œè¿™ä¸ª GestureRecognizer
[view addGestureRecognizer:tap];

- (void)didTap:(UITapGestureRecognizer *)gr {
  if (gr.state == UIGestureRecognizerStateRecognized) {
    // handle tap
  }
}
```

é€šè¿‡ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸¤ç‚¹ç»“è®ºï¼š

1. GestureRecognizer éœ€è¦ç”± view ä¸»åŠ¨æ·»åŠ ï¼ˆç¬¬ 5 è¡Œçš„ `addGestureRecognizer`)ï¼Œè€Œä¸åƒ `UIResponder` è‡ªåŠ¨ç»§æ‰¿
2. GestureRecognizer å†…éƒ¨ä¸»è¦ç”±çŠ¶æ€ **state** é©±åŠ¨

<br />

æˆ‘ä»¬æ¥çœ‹çœ‹ [Event Handling Guide for iOS](https://github.com/BladeTail/Event-Handling-Guide-for-iOS/blob/master/Event%20Handling%20Guide%20for%20iOS.pdf) ä¸­æ˜¯å¦‚ä½•æè¿° IOS é»˜è®¤çš„äº‹ä»¶ä¼ é€’æœºåˆ¶çš„ï¼š

 ![ios event delivery path](https://github.com/Joyee691/image-hosting/blob/main/blog/RN_ios_event_delivery_path.jpg?raw=true)

> In the simple case, when a touch occurs, the touch object is passed from the UIApplication object to the UIWindow object. Then, the window first sends touches to any gesture recognizers attached the view where the touches occurred (or to that viewâ€™s superviews), before it passes the touch to the view object itself.
>
> (from Event Handling Guide for iOS page 25)
>
> ç®€å•ç¿»è¯‘ï¼šå½“ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶è¢«è§¦å‘çš„æ—¶å€™ï¼Œä¼šå…ˆä» UIApplication(å¯¹åº”å›¾ä¸­çš„ APP) ä¼ é€’åˆ° UIWindow(å¯¹åº”å›¾ä¸­çš„ Window)ï¼Œç„¶åä¼šä¼˜å…ˆä¼ é€’ç»™ view ä¸Šé™„ç€çš„ GestureRecognizerï¼Œå…¶æ¬¡æ‰æ˜¯ä¼ é€’ç»™ view è§¦å‘ UIResponder çš„å¤„ç†æ–¹æ³•

<br />

äº†è§£äº† GestureRecognizer çš„æœºåˆ¶ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå†…éƒ¨åšäº†å“ªäº›äº‹æƒ…

é¦–å…ˆåœ¨ GestureRecognizer å†…éƒ¨ï¼Œä¹Ÿæœ‰è·Ÿ UIResponder ä¸€æ ·çš„ `touchesBegan`ã€`touchesMoved` ç­‰å›è°ƒæ¥å“åº”ä¸åŒçš„äº‹ä»¶

å…¶æ¬¡ GestureRecognizer åœ¨æ­¤ä¹‹ä¸Šè¿˜ç»´æŠ¤äº†ä¸€å¥—çŠ¶æ€æœºï¼Œç”¨æ¥å°†ä¸åŒçš„äº‹ä»¶æŠ½è±¡æˆä¸€ä¸ªä¸ªæ‰‹åŠ¿çš„çŠ¶æ€

è®©æˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

| å½“å‰äº‹ä»¶                | GestureRecognizer | tapGestureRecognizer.state | View         |
| ----------------------- | ----------------- | -------------------------- | ------------ |
| 1. ç”¨æˆ·æ‰‹æŒ‡è§¦æ‘¸å±å¹•     | touchesBegan      | Possible                   | touchesBegan |
| 2. ç”¨æˆ·æ‰‹æŒ‡åœ¨å±å¹•ä¸ŠåŠ¨äº† | touchesMoved      | Possible                   | touchesMoved |
| 3. ç”¨æˆ·æ‰‹æŒ‡ç¦»å¼€å±å¹•     | touchesEnded      | Recognized                 | touchesEnded |

æˆ‘ä»¬æŠŠç‚¹å‡»äº‹ä»¶åˆ†æˆäº†ä¸‰ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«å¯¹åº”åˆ°ä¸Šé¢è¡¨æ ¼ä¸­çš„ä¸‰ä¸ªå½“å‰äº‹ä»¶

- å½“ç”¨æˆ·æ‰‹æŒ‡è§¦æ‘¸å±å¹•æ—¶ï¼Œé¦–å…ˆ GestureRecognizer å†…éƒ¨çš„ touchesBegan ä¼šè¢«è§¦å‘ï¼Œå®ƒä¼šå°†å†…éƒ¨çš„ state ä¼šç»´æŒ **Possible**ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰è¯†åˆ«åˆ°æ‰‹åŠ¿ï¼‰ï¼Œç„¶å View æ‰ä¼šæ”¶åˆ°è¯¥äº‹ä»¶å¹¶è§¦å‘ View çš„ touchesBegan
- å½“ç”¨æˆ·æ‰‹æŒ‡åœ¨å±å¹•ä¸ŠåŠ¨äº†æ—¶ï¼Œæƒ…å†µä¸ä¸Šè¿°ç±»ä¼¼
- å½“ç”¨æˆ·æ‰‹æŒ‡ç¦»å¼€å±å¹•æ—¶ï¼ŒGestureRecognizer çš„ touchesBegan è¢«è§¦å‘ï¼Œå®ƒç¡®è®¤äº†æ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œæ‰€ä»¥å°†å†…éƒ¨çš„ state åˆ‡æ¢æˆäº† **Recognized**ï¼Œç„¶å View æ‰ä¼šæ”¶åˆ°è¯¥äº‹ä»¶å¹¶è§¦å‘ View çš„ touchesBegan

<br />

åœ¨ GestureRecognizer çš„å†…éƒ¨ï¼Œå°†æ‰€æœ‰çš„æ‰‹åŠ¿åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

- ç¦»æ•£å‹æ‰‹åŠ¿ï¼šæ¯”å¦‚ç‚¹å‡»äº‹ä»¶çš„ UITapGestureRecognizer
- æŒç»­å‹æ‰‹åŠ¿ï¼šæ¯”å¦‚é•¿æŒ‰äº‹ä»¶çš„ UILongPressGestureRecorgnizer

æ¯ä¸€ç§æ‰‹åŠ¿ï¼Œéƒ½æœ‰ä¸€ä¸ªå†…éƒ¨çš„çŠ¶æ€æœºæ¥åˆ¤æ–­å½“å‰çŠ¶æ€ï¼š

- ç¦»æ•£å‹æ‰‹åŠ¿ï¼š`Possible -> Recognized/Failed`ï¼ˆRecognized è¡¨ç¤ºè¯†åˆ«æˆåŠŸï¼›Failed è¡¨ç¤ºè¯†åˆ«å¤±è´¥ï¼‰
- æŒç»­å‹æ‰‹åŠ¿ï¼š`Possible -> Begin -> [Changed] -> Ended/Cancel`ï¼ˆEnded è¡¨ç¤ºè¯†åˆ«æˆåŠŸï¼›Cancel è¡¨ç¤ºè¯†åˆ«å¤±è´¥ï¼‰

å¼€å‘è€…å¯ä»¥é€šè¿‡åˆ¤æ–­ä¸€ä¸ª GestureRecognizer çš„çŠ¶æ€ï¼Œæ¥æ‰§è¡Œä¸åŒçš„å¤„ç†é€»è¾‘ï¼ˆå‚è€ƒä¸Šä¸€ä¸ªä»£ç ç‰‡æ®µç¬¬ 8 è¡Œï¼‰

### UIGestureRecognizer ä¸ UIResponder

å¦‚æœä¸Šæ–‡çš„ UIGestureRecognizer æŠŠä½ å½»åº•ææ‡µäº†çš„è¯ï¼Œæœ¬å°èŠ‚æ˜¯ä¸“é—¨ç”¨æ¥ç­”ç–‘è§£æƒ‘çš„

æˆ‘ä»¬æ¥ä¸‹æ¥ä¼šç”¨ä¸€ä¸ªä¾‹å­æ¥äº†è§£ IOS ä¸­å¤„ç†äº‹ä»¶çš„å…¨è²Œï¼š

```js
ViewA <- add TapGestureRecognizer
 â””â”€ ViewB
      â””â”€ ViewC <- override touchesXXX 
```

å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªå…ƒç´ ï¼ŒViewA æ˜¯ ViewB çš„çˆ¶å…ƒç´ ã€ViewB æ˜¯ ViewC çš„çˆ¶å…ƒç´ 

ç”¨æˆ·ç‚¹å‡»äº† ViewC å…ƒç´ ï¼ˆHit-testing å‘½ä¸­äº† ViewCï¼Œå¯¹åº”åˆ°æœ¬ç« èŠ‚å¼€å§‹çš„ç¬¬ 5 æ­¥ï¼‰æ—¶ï¼š

1. `UIWindow` ä¼šæŠŠå½“å‰çš„ touch äº‹ä»¶å‘é€åˆ°ä»»ä½•é™„ç€åœ¨å½“å‰ Viewï¼ˆä»¥åŠå…¶æ‰€æœ‰çˆ¶å…ƒç´ ï¼‰çš„ GestureRecognizer ä¸­ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯ ViewA çš„ TapGestureRecognizer ä¼šæœ€å…ˆæ„ŸçŸ¥åˆ°äº‹ä»¶å‘ç”Ÿï¼‰
2. é»˜è®¤æƒ…å†µï¼ˆ[GestureRecognizer.delaysTouchesBegan](https://developer.apple.com/documentation/uikit/uigesturerecognizer/delaystouchesbegan?language=objc) === falseï¼‰ä¸‹ï¼Œ`UIWindow` ä¼šéšåæŠŠ touch äº‹ä»¶å‘é€ç»™ ViewCï¼Œç„¶åè§¦å‘ touchesBegan çš„é‡è½½é€»è¾‘ï¼ˆè¿›å…¥åŸºäº View çš„å“åº”é“¾ï¼‰
3. å¦‚æœ TapGestureRecognizer æˆåŠŸè¯†åˆ«äº†è¯¥æ‰‹åŠ¿ï¼Œå®ƒä¼šè§¦å‘è‡ªå·±çš„ actionï¼Œè°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„æ–¹æ³•
4. ä¸æ­¤åŒæ—¶ï¼Œåœ¨é»˜è®¤æƒ…å†µï¼ˆ[GestureRecognizer.cancelsTouchesInView](https://developer.apple.com/documentation/uikit/uigesturerecognizer/cancelstouchesinview?language=objc) === trueï¼‰ä¸‹ï¼ŒViewC ä¼šæ¥æ”¶åˆ°å½“å‰äº‹ä»¶çš„ cancel ç»ˆæ­¢å½“å‰äº‹ä»¶å¤„ç†

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªé‡ç‚¹ï¼š

1. å¦‚æœä¸€ä¸ª View è¢«å‘½ä¸­äº†ï¼Œå®ƒæ‰€æœ‰çˆ¶å…ƒç´ ä¸Šé™„ç€çš„ GestureRecognizer éƒ½ä¼šè¢« â€œå‘ŠçŸ¥â€
2. å½“ä»»ä½•äº‹ä»¶è¢«è§¦å‘æ—¶ï¼ŒGestureRecognizer æ€»æ˜¯ç¬¬ä¸€ä¸ªè¢« â€œå‘ŠçŸ¥â€ çš„

æ˜¯ä¸æ˜¯å¾ˆé€‚é… RN å‘¢ğŸ˜†

## RN äº‹ä»¶å¤„ç†æœºåˆ¶å®ç°

åœ¨ä¸Šé¢ä¸¤ä¸ªç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«èŠäº†åŸç”Ÿçš„ IOS ä¸ Android çš„äº‹ä»¶å¤„ç†æœºåˆ¶

åœ¨è¿™ä¸€ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬è¦æŠŠè¿™äº›æœºåˆ¶å¸¦è¿› RN çš„è®¾è®¡ï¼Œçœ‹çœ‹ RN æ˜¯å¦‚ä½•åœ¨ä¸åŒçš„å¹³å°ä¹‹ä¸ŠæŠ½è±¡å‡ºä¸€å¥—æœºåˆ¶æŠ¹å¹³å¹³å°å·®å¼‚çš„è§£å†³æ–¹æ¡ˆ

ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬ä¼šä»¥ä¸€ä¸ªä¾‹å­ä¸ºåˆ‡å…¥ç‚¹ï¼š

```jsx
<Button
  onPress={() => {
    console.log('You tapped the button!');
  }}
  title="Press Me"
/>
```

è¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„ button ç»„ä»¶ï¼Œå…¶ä¸­ onPress å±æ€§æ³¨å†Œäº†ä¸€ä¸ªç‚¹å‡»äº‹ä»¶çš„å›è°ƒæ–¹æ³•ã€title åˆ™å®šä¹‰äº†æŒ‰é’®è¦å±•ç¤ºçš„æ–‡æ¡ˆ

<br />

ç«™åœ¨ RN æ¡†æ¶å¼€å‘è€…çš„è§†è§’æ¥çœ‹ï¼Œæˆ‘ä»¬æƒ³è¦å°†äº‹ä»¶å¤„ç†çš„é€»è¾‘å°½å¯èƒ½çš„ç»Ÿä¸€ï¼Œä»è€ŒæŠ¹å¹³ä¸åŒå¹³å°ä¹‹é—´çš„å·®å¼‚

è‡ªç„¶è€Œç„¶çš„ï¼Œæˆ‘ä»¬ä¼šéœ€è¦åŒºåˆ†å‡ºä¸¤ä¸ªè§’è‰²ï¼š

- ç”Ÿäº§è€…ï¼šä»£è¡¨æ–¹æ˜¯åŸç”Ÿçš„å¹³å°ã€‚å®ƒä»¬è´Ÿè´£å°†ç”¨æˆ·äº‹ä»¶**å°½å¯èƒ½å…¨**ã€**å°½å¯èƒ½æ—©**çš„**åŒ…è£…**å¥½åå‘é€ç»™ JS ä¾§
- æ¶ˆè´¹è€…ï¼šä»£è¡¨æ–¹æ˜¯ JS ä»£ç ã€‚å®ƒè´Ÿè´£**æ¥æ”¶äº‹ä»¶**ï¼Œ**å°†äº‹ä»¶è¯­ä¹‰åŒ–**ï¼Œæœ€å**è§¦å‘äº‹ä»¶å›è°ƒ**

ç”±äºè¿™å¥—æœºåˆ¶éœ€è¦åŒæ–¹å…±åŒå‚ä¸ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šå…ˆèŠèŠ RN åœ¨ IOS ä¾§ä¸ Android ä¾§åˆ†åˆ«åšäº†ä»€ä¹ˆï¼Œå†æ¥çœ‹çœ‹ JS ä¾§æ˜¯å¦‚ä½•å¤„ç†åŒç«¯ä¼ è¿‡æ¥çš„æ•°æ®çš„

### Android ä¾§

åœ¨ä¸Šæ–‡ **Android çš„äº‹ä»¶å¤„ç†æœºåˆ¶** ä¸­æˆ‘ä»¬èŠåˆ°ï¼ŒAndroid æ‰€æœ‰çš„äº‹ä»¶éƒ½ä¼šé€šè¿‡æ ¹å…ƒç´ ä¸€å±‚ä¸€å±‚å‘ä¸‹ä¼ é€’ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ„¿æ„æ¶ˆè´¹è¯¥äº‹ä»¶çš„å…ƒç´ 

æ‰€ä»¥ï¼Œä¸ºäº†æ»¡è¶³å°½å¯èƒ½å…¨ä»¥åŠå°½å¯èƒ½æ—©çš„æŠŠæ¶ˆæ¯å‘é€ç»™ JS ä¾§ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æˆ‘ä»¬æ‰€èƒ½æ§åˆ¶çš„æœ€ä¸Šå±‚èŠ‚ç‚¹ï¼ˆåœ¨ Android ä¸­ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯ `ReactRootView`ï¼‰

æ‰¾åˆ°æ ¹èŠ‚ç‚¹ä»¥åï¼Œæˆ‘ä»¬è¦å¼€å§‹éªšæ“ä½œäº†ï¼šé‡è½½ `onInterceptTouchEvent` ä¸ `onTouchEvent`

```java
// in ReactRootView.java

@Override
public boolean onInterceptTouchEvent(MotionEvent ev) {
  dispatchJSTouchEvent(ev);
  return super.onInterceptTouchEvent(ev);
}

@Override
public boolean onTouchEvent(MotionEvent ev) {
  dispatchJSTouchEvent(ev);
  super.onTouchEvent(ev);
  // In case when there is no children interested in handling touch event, we return true from
  // the root view in order to receive subsequent events related to that gesture
  return true;
}
```

> è¿˜è®°å¾—æˆ‘ä»¬åœ¨ **Android çš„äº‹ä»¶å¤„ç†æœºåˆ¶** ä¸­è¯´æ˜çš„å—ï¼Ÿå½“äº‹ä»¶ä¼ é€’åˆ°å¯¹åº”çš„ View æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ `onInterceptTouchEvent` åˆ¤æ–­å½“å‰ View æ˜¯å¦è¦æ‹¦æˆªè¯¥äº‹ä»¶ï¼Œå¦‚æœæ‹¦æˆªäº†ä¼šç›´æ¥è°ƒç”¨å½“å‰ View ä¸­çš„ `onTouchEvent` æ–¹æ³•æ¶ˆè´¹è¯¥äº‹ä»¶ï¼›å¦åˆ™ä¼šç»§ç»­å°†è¯¥äº‹ä»¶å¾€ä¸‹ä¼ é€’çŸ¥é“é‡åˆ°æ„¿æ„æ¶ˆè´¹è¯¥äº‹ä»¶çš„å…ƒç´ æˆ–è€…é‡æ–°è¿”å›å½“å‰çš„ View è°ƒç”¨ `onTouchEvent` æ–¹æ³•å…œåº•

åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆé‡è½½äº† `onInterceptTouchEvent` æ–¹æ³•ï¼Œè°ƒç”¨äº† `dispatchJSTouchEvent` æ–¹æ³•**æŠŠå½“å‰äº‹ä»¶å‘é€ç»™ JS ä¾§**ï¼ˆè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬æœ¬å°èŠ‚åé¢å±•å¼€èŠï¼‰ï¼Œåœ¨æ­¤ä¹‹åå®ƒè¿”å›äº†ä¸€ä¸ª `super.onInterceptTouchEvent(ev)` ï¼ˆåœ¨æ²¡æœ‰ç‰¹æ®Šæƒ…å†µä¸‹å®ƒçš„å€¼æ˜¯ falseï¼Œä»£è¡¨ä¼šç»§ç»­å°†è¯¥äº‹ä»¶å¾€ä¸‹ä¼ é€’ï¼‰

å…¶æ¬¡æˆ‘ä»¬è¿˜é‡è½½äº† `onTouchEvent` æ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›äº† trueï¼ˆä»£è¡¨å¦‚æœä¸‹é¢çš„å…ƒç´ éƒ½æ²¡æœ‰æ¶ˆè´¹è¿™ä¸ªäº‹ä»¶ï¼Œå®ƒä¼šè´Ÿè´£å…œåº•ï¼‰

æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œ`onTouchEvent` ä¸­ä¹Ÿè°ƒç”¨äº† `dispatchJSTouchEvent` å‘é€å½“å‰äº‹ä»¶ç»™ JS ä¾§ï¼Œè¿™ä¸é‡å¤äº†å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šå¦‚æœæ‰€æœ‰çš„å­å…ƒç´ éƒ½ä¸æ¶ˆè´¹è¿™ä¸ªäº‹ä»¶çš„è¯ï¼Œç¡®å®ä¼šé‡å¤ï¼Œä½†æ˜¯åœ¨å¤§éƒ¨ä»½æƒ…å†µä¸‹å­å…ƒç´ éƒ½ä¼šæ¶ˆè´¹äº‹ä»¶ï¼ˆæˆ‘ä»¬åé¢ä¼šèŠåˆ°ï¼‰æ‰€ä»¥è¿™é‡Œçš„ `onTouchEvent` åœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µéƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œåªæ˜¯ä¸€ä¸ªå…œåº•é€»è¾‘

#### Button çš„ä¾‹å­

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°åœ¨ `ReactRootView` ä¸­çš„ `onInterceptTouchEvent` ä¼šè¿”å› false å¹¶å°†è¯¥æ¶ˆæ¯ä¼ é€’ä¸‹å»ç›´åˆ°æ‰¾åˆ°çœŸæ­£çš„æ¶ˆè´¹å…ƒç´ 

æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥æœ¬ç« èŠ‚å¼€å¤´çš„ button ä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹åœ¨ Android ä¾§æ˜¯è°æ¥å®Œæˆäº‹ä»¶æ¶ˆè´¹é—­ç¯çš„

å…ˆæ¥çœ‹ä¸€æ®µ Button ç»„ä»¶åœ¨ JS ä¾§æ˜¯æ€ä¹ˆè¢«å°è£…çš„å§ï¼š

```jsx
// in Button.js

class Button extends React.Component<{...}> {
	// ... çœç•¥éƒ¨ä»½ä»£ç 
	render() {
    // ... çœç•¥éƒ¨ä»½ä»£ç 
    const Touchable =
      Platform.OS === 'android' ? TouchableNativeFeedback : TouchableOpacity;
    return (
      <Touchable
        // ... çœç•¥éƒ¨ä»½ä»£ç 
      	disabled={disabled}
        onPress={onPress}>
        <View style={buttonStyles}>
          <Text style={textStyles} disabled={disabled}>
            {formattedTitle}
          </Text>
        </View>
      </Touchable>
    );
  }
}
```

å¯ä»¥çœ‹åˆ° Button ç»„ä»¶åœ¨ä¸åŒçš„åŸç”Ÿå¹³å°ä¸‹ï¼Œåˆ†åˆ«ç”±ä¸¤ä¸ªç»„ä»¶æ¥å®ç°ï¼šAndroid ä¸­æ˜¯ `TouchableNativeFeedback`ï¼›IOS ä¸­æ˜¯ `TouchableOpacity`

è¿™ä¸¤ä¸ªç»„ä»¶å°è£…äº†å¯¹ä¸åŒåŸç”Ÿå¹³å°å·®å¼‚çš„å¤„ç†ï¼Œåœ¨æœ¬å°èŠ‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ `TouchableNativeFeedback`ï¼ˆIOS çš„ `TouchableOpacity` å¯ä»¥çœ‹æœ¬æ–‡çš„ **IOS ä¾§** éƒ¨ä»½ï¼‰ï¼š

```js
// in TouchableNativeFeedback.android.js

const TouchableNativeFeedback = createReactClass({
	// ... çœç•¥éƒ¨ä»½ä»£ç 
  render: function() {
    const child = React.Children.only(this.props.children);
    const childProps = {
      ...child.props,
      // ... çœç•¥éƒ¨ä»½ä»£ç 
    }
    // ... çœç•¥éƒ¨ä»½ä»£ç 
    return React.cloneElement(child, childProps);
  }
})
```

å¯ä»¥çœ‹åˆ°ï¼Œ`TouchableNativeFeedback`  çš„ `render`  å‡½æ•°æœ€åè¿”å›äº†è‡ªå·±çš„ childï¼ˆä¹Ÿå°±æ˜¯ä¸Šä¸€ä¸ªä»£ç ç‰‡æ®µä¸­çš„ View å…ƒç´ ï¼‰

è¿™ä¸ª View å…ƒç´ åœ¨ç»å†äº† RN çš„å¸ƒå±€ç»˜åˆ¶åï¼Œä¼šè¢«å½“æˆä¸€ä¸ª `ReactViewGroup` åˆ›å»ºï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥çœ‹çœ‹ `ReactViewGroup` æ˜¯å¦‚ä½•å¤„ç†äº‹ä»¶çš„ï¼š

```java
// in ReactViewGroup.java

public class ReactViewGroup extends ViewGroup implements
    ReactInterceptingViewGroup, ReactClippingViewGroup, ReactPointerEventsView, ReactHitSlopView,
    ReactZIndexedViewGroup {
  // ... çœç•¥éƒ¨ä»½ä»£ç 
  private PointerEvents mPointerEvents = PointerEvents.AUTO;
  private @Nullable OnInterceptTouchEventListener mOnInterceptTouchEventListener;
  // ... çœç•¥éƒ¨ä»½ä»£ç 
      
  @Override
  public boolean onInterceptTouchEvent(MotionEvent ev) {
    if (mOnInterceptTouchEventListener != null &&
        mOnInterceptTouchEventListener.onInterceptTouchEvent(this, ev)) {
      return true;
    }
    // We intercept the touch event if the children are not supposed to receive it.
    if (mPointerEvents == PointerEvents.NONE || mPointerEvents == PointerEvents.BOX_ONLY) {
      return true;
    }
    return super.onInterceptTouchEvent(ev);
  }

  @Override
  public boolean onTouchEvent(MotionEvent ev) {
    // We do not accept the touch event if this view is not supposed to receive it.
    if (mPointerEvents == PointerEvents.NONE || mPointerEvents == PointerEvents.BOX_NONE) {
      return false;
    }
    // The root view always assumes any view that was tapped wants the touch
    // and sends the event to JS as such.
    // We don't need to do bubbling in native (it's already happening in JS).
    // For an explanation of bubbling and capturing, see
    // http://javascript.info/tutorial/bubbling-and-capturing#capturing
    return true;
  }
```

ä»£ç æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ `onInterceptTouchEvent` ä»¥åŠ `onTouchEvent` æ–¹æ³•

åœ¨ `onInterceptTouchEvent` ä¸­ä¸€å…±åšäº†ä¸¤æ¬¡åˆ¤æ–­ï¼š

1. `mOnInterceptTouchEventListener`ï¼šè¿™ä¸ªæ˜¯ä¸€ä¸ªé’©å­ï¼Œç”¨æ¥è®© JS åŠ¨æ€å†³å®šæ˜¯å¦è¦åœ¨è¿™é‡Œæ‹¦æˆªè¿™ä¸ªæ¶ˆæ¯
2. `mPointerEvents`ï¼šæ˜¯ä¸€ä¸ªå±æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ AUTOï¼Œä¹Ÿæ˜¯è®© JS å†³å®šæ˜¯å¦è¦æ‹¦æˆªè¿™ä¸ªæ¶ˆæ¯ï¼ŒåŒºåˆ«åœ¨äºå®ƒæ˜¯é™æ€çš„

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªåˆ¤æ–­éƒ½æ˜¯ falseï¼Œ`ReactViewGroup` ä¼šæŠŠè¿™ä¸ªäº‹ä»¶ç»§ç»­ä¼ ä¸‹å»

å…³é”®åœ¨äº `onTouchEvent` æ–¹æ³•ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šè¿”å› trueï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šå…œåº•æˆä¸ºè¯¥äº‹ä»¶çš„æ¶ˆè´¹æ–¹ï¼‰

äºæ˜¯ï¼Œ`ReactRootView` ä¸­çš„ `dispatchJSTouchEvent` æ–¹æ³•ä¸ä¼šè¢«è§¦å‘ï¼ŒJS ä¾§ä¹Ÿå°±ä¸ä¼šæ¥å—åˆ°é‡å¤çš„äº‹ä»¶äº†

#### dispatchJSTouchEvent

`dispatchJSTouchEvent` çš„èŒè´£é™¤äº†æŠŠäº‹ä»¶ä» Android ä¾§å‘é€ç»™ JS ä¾§ï¼Œè¿˜éœ€è¦æŠŠ Android ä¾§ç‹¬æœ‰çš„äº‹ä»¶å°è£…æˆ JS ä¾§èƒ½å¤Ÿæ¶ˆè´¹çš„äº‹ä»¶

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„å®ç°ï¼š

```java
// in ReactRootView.java

public class ReactRootView extends SizeMonitoringFrameLayout 
	implements RootView, MeasureSpecProvider {
    // ... çœç•¥éƒ¨ä»½ä»£ç 
    private void dispatchJSTouchEvent(MotionEvent event) {
        // ... çœç•¥éƒ¨ä»½ä»£ç 
        ReactContext reactContext = mReactInstanceManager.getCurrentReactContext();
        EventDispatcher eventDispatcher = reactContext.getNativeModule(UIManagerModule.class).getEventDispatcher();
        // å¤„ç†è§¦æ‘¸äº‹ä»¶çš„æ–¹æ³•
        mJSTouchDispatcher.handleTouchEvent(event, eventDispatcher);
      }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå°†è§¦æ‘¸äº‹ä»¶çš„å¤„ç†å§”æ‰˜ç»™äº† `mJSTouchDispatcher` å®ä¾‹ä¸­çš„ `handleTouchEvent` æ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯å®ƒçš„å®ç°ï¼š

```java
// in JSTouchDispatcher.java

public class JSTouchDispatcher {
  // ... çœç•¥éƒ¨ä»½ä»£ç 
  
  public void handleTouchEvent(MotionEvent ev, EventDispatcher eventDispatcher) {
    // åˆ¤æ–­å½“å‰äº‹ä»¶ç±»å‹ï¼Œåç»­æˆ‘ä»¬ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹åšä¸åŒçš„æ•°æ®å¤„ç†
    int action = ev.getAction() & MotionEvent.ACTION_MASK;
    // å¤„ç† ACTION_DOWN äº‹ä»¶ï¼Œæ ‡è¯†å½“å‰ç”¨æˆ·æ‰‹æŒ‡æ”¾ä¸Šå±å¹•äº†
    if (action == MotionEvent.ACTION_DOWN) {
      // è¿™é‡Œåšäº†ä¸€ä¸ªæ—¥å¿—çš„æŠ¥é”™ï¼Œå¦‚æœè¿ç»­æ¥æ”¶åˆ°ä¸¤ä¸ª ACTION_DOWN äº‹ä»¶çš„æ—¶å€™å°±ä¼šè§¦å‘
      // mTargetTag åœ¨ä¸‹é¢ä¼šè¢«èµ‹å€¼ï¼Œä»£è¡¨å¤„ç†æ­¤äº‹ä»¶çš„ç›®æ ‡ç»„ä»¶/å…ƒç´ 
      if (mTargetTag != -1) {
        FLog.e(
          ReactConstants.TAG,
          "Got DOWN touch before receiving UP or CANCEL from last gesture");
      }
	
      // è®°å½•å½“å‰äº‹ä»¶æ—¶é—´æˆ³
      mGestureStartTime = ev.getEventTime();
      // RN è‡ªå·±å®ç°çš„ hit-test é€»è¾‘ï¼Œé€’å½’æ‰¾åˆ°äº†åº”è¯¥æ¶ˆè´¹çš„ Viewï¼Œå¹¶ä¸”è¿”å›äº†è¯¥ View çš„ tag
      // è¿™ä¸ª tag æ˜¯å½“ js ä¾§è°ƒç”¨ createView æ—¶ä¼ è¿‡æ¥çš„ tagï¼Œå”¯ä¸€æ ‡è¯†äº†ä¸€ä¸ª js ä¾§çš„å…ƒç´ 
      mTargetTag = findTargetTagAndSetCoordinates(ev);
      // æŠŠ ACTION_DOWN äº‹ä»¶åŒ…è£…åå‘ç»™ js ce
      eventDispatcher.dispatchEvent(
        TouchEvent.obtain(
          mTargetTag,
          TouchEventType.START,
          ev,
          mGestureStartTime,
          mTargetCoordinates[0],
          mTargetCoordinates[1],
          mTouchEventCoalescingKeyHelper));
      // ä»¥ä¸‹çš„ else çœç•¥äº†ä¸€äº›åœºæ™¯çš„å¤„ç†é€»è¾‘ï¼Œåªé‡ç‚¹æ”¾äº†ç‚¹å‡»äº‹ä»¶ç›¸å…³çš„å¤„ç†é€»è¾‘
    } else if (action == MotionEvent.ACTION_UP) {
      // å¤„ç† ACTION_UP äº‹ä»¶ï¼Œæ ‡è¯†å½“å‰ç”¨æˆ·æ‰‹æŒ‡ç¦»å¼€å±å¹•äº†
      
      // æ›´æ–°äº† mTargetCoordinatesï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥è¡¨ç¤ºå½“å‰ç”¨æˆ·æ‰‹æŒ‡ä½ç½®
      findTargetTagAndSetCoordinates(ev);
      // åŒ…è£…å¹¶å‘é€äº‹ä»¶ç»™ js ä¾§
      eventDispatcher.dispatchEvent(
        TouchEvent.obtain(
          mTargetTag,
          TouchEventType.END,
          ev,
          mGestureStartTime,
          mTargetCoordinates[0],
          mTargetCoordinates[1],
          mTouchEventCoalescingKeyHelper));
      // æ¢å¤æˆåˆå§‹çŠ¶æ€
      mTargetTag = -1;
      mGestureStartTime = TouchEvent.UNSET;
    } else if (action == MotionEvent.ACTION_MOVE) {
			// å¤„ç† ACTION_MOVE äº‹ä»¶ï¼Œæ ‡è¯†å½“å‰ç”¨æˆ·æ‰‹æŒ‡åœ¨å±å¹•ä¸Šçš„ç§»åŠ¨
      
      // æ›´æ–°äº† mTargetCoordinates
      findTargetTagAndSetCoordinates(ev);
      
      // åŒ…è£…å¹¶å‘é€äº‹ä»¶ç»™ js ä¾§
      eventDispatcher.dispatchEvent(
        TouchEvent.obtain(
          mTargetTag,
          TouchEventType.MOVE,
          ev,
          mGestureStartTime,
          mTargetCoordinates[0],
          mTargetCoordinates[1],
          mTouchEventCoalescingKeyHelper));
    }  else {
      // å…œåº•é€»è¾‘
      FLog.w(
        ReactConstants.TAG,
        "Warning : touch event was ignored. Action=" + action + " Target=" + mTargetTag);
    }
  }
}
```

ä»£ç éƒ¨ä»½çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†æ˜¯å…¶å®åªåŒ…å«äº†ä¸‰ä¸ªéƒ¨ä»½ï¼š

1. å¯¹ `ACTION_DOWN` äº‹ä»¶çš„å¤„ç†
2. å¯¹ `ACTION_UP` äº‹ä»¶çš„å¤„ç†
3. å¯¹ `ACTION_MOVE` äº‹ä»¶çš„å¤„ç†

è¿™ä¸‰ä¸ªäº‹ä»¶çš„å¤„ç†è¯´ç™½äº†å°±æ˜¯æŠŠäº‹ä»¶åŒ…è£…å¥½åå‘é€ç»™ js ä¾§ä¾› js æ¶ˆè´¹

è‡³æ­¤ï¼ŒAndroid ä¾§çš„å·¥ä½œå·²å®Œç»“æ’’èŠ±ï½ğŸ‰

### IOS ä¾§

IOS ä¾§èº«ä¸ºäº‹ä»¶çš„å¦ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå®ƒçš„èŒè´£ä¹Ÿæ˜¯**å°†äº‹ä»¶å°½å¯èƒ½æ—©ã€å°½å¯èƒ½å¿«çš„åŒ…è£…å¥½ä¼ é€’ç»™ JS ä¾§**

åœ¨ä¸Šæ–‡ **IOS çš„äº‹ä»¶å¤„ç†æœºåˆ¶** ä¸­ï¼Œæˆ‘ä»¬èŠåˆ°äº† **UIGestureRecognizer** çš„ä¸¤ä¸ªç‰¹æ€§ï¼š

1. å¦‚æœä¸€ä¸ª View è¢«å‘½ä¸­äº†ï¼Œå®ƒæ‰€æœ‰çˆ¶å…ƒç´ ä¸Šé™„ç€çš„ GestureRecognizer éƒ½ä¼šè¢« â€œå‘ŠçŸ¥â€
2. å½“ä»»ä½•äº‹ä»¶è¢«è§¦å‘æ—¶ï¼ŒGestureRecognizer æ€»æ˜¯ç¬¬ä¸€ä¸ªè¢« â€œå‘ŠçŸ¥â€ çš„

æ ¹æ®è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬èƒ½æ§åˆ¶çš„æœ€ä¸Šå±‚èŠ‚ç‚¹ï¼ˆIOS ä¸­è¿™ä¸ªèŠ‚ç‚¹æ˜¯ RCTRootContentViewï¼‰é™„ç€ UIGestureRecognizerï¼Œç„¶åå®šåˆ¶å…¶ä¸­çš„ touchesBegan ç­‰äº‹ä»¶çš„å›è°ƒï¼Œä»è€Œå±¥è¡Œä¸Šè¿°çš„èŒè´£

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ RN æ˜¯å¦‚ä½•å®ç°çš„ï¼š

```objc
// ç¬¬ä¸€æ­¥ï¼šæŠŠ UIGestureRecognizer é™„ç€åœ¨ RCTRootContentView ä¸Š
// in RCTRootContentView.m
- (instancetype)initWithFrame:(CGRect)frame
                       bridge:(RCTBridge *)bridge
                     reactTag:(NSNumber *)reactTag
               sizeFlexiblity:(RCTRootViewSizeFlexibility)sizeFlexibility
{
  if ((self = [super initWithFrame:frame])) {
    // ...çœç•¥éƒ¨ä»½ä»£ç 
    
    // åˆå§‹åŒ– RCTTouchHandler å¹¶å–å¾—å…¶å®ä¾‹
    _touchHandler = [[RCTTouchHandler alloc] initWithBridge:_bridge];
    // è°ƒç”¨ RCTTouchHandler çš„ attachToView æ–¹æ³•ï¼ˆä¸‹é¢ä¼šæœ‰å®ç°ï¼‰
    [_touchHandler attachToView:self];

    // ...çœç•¥éƒ¨ä»½ä»£ç 
  }
  return self;
}

// in RCTTouchHandler.m
- (void)attachToView:(UIView *)view
{
  RCTAssert(self.view == nil, @"RCTTouchHandler already has attached view.");

  // attachToView æ–¹æ³•çš„å®ç°ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„ addGestureRecognizer æŠŠ UIGestureRecognizer é™„ç€ä¸Šäº† RCTRootContentView
  [view addGestureRecognizer:self];
}
```

ä¸Šé¢çš„ä»£ç å±•ç¤ºäº† RN æ˜¯å¦‚ä½•å°† RCTTouchHandler é™„ç€åœ¨ RCTRootContentView èŠ‚ç‚¹ä¸Šçš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ RCTTouchHandler æ˜¯ä»€ä¹ˆï¼Œä»¥åŠåšäº†ä»€ä¹ˆäº‹ï¼š

```js
// ç¬¬äºŒæ­¥ï¼šä¿®æ”¹äº‹ä»¶å›è°ƒçš„å®ç°
// in RCTTouchHandler.h
// ... çœç•¥éƒ¨ä»½ä»£ç 

// ä»è¿™é‡Œå¯ä»¥çœ‹åˆ° RCTTouchHandler ç»§æ‰¿äº† UIGestureRecognizer
@interface RCTTouchHandler : UIGestureRecognizer

// in RCTTouchHandler.m
// é‡è½½ UIGestureRecognizer çš„ touchesBegan æ–¹æ³•
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
	// è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œä¿è¯ IOS çš„äº‹ä»¶ç³»ç»ŸåŒæ­¥åˆ°äº†è¿™ä¸ªäº‹ä»¶ï¼ˆå¦åˆ™å°±è¢«æ‹¦æˆªåœ¨è¿™é‡Œäº†ï¼‰
  [super touchesBegan:touches withEvent:event];

	// ...çœç•¥éƒ¨ä»½ä»£ç 

	// å°† touchStart äº‹ä»¶åŒ…è£…åå‘é€ç»™ js ä¾§
  [self _updateAndDispatchTouches:touches eventName:@"touchStart"];

	// ä¿è¯ IOS Recognizer çŠ¶æ€æœºçš„æ­£å¸¸æµè½¬
  if (self.state == UIGestureRecognizerStatePossible) {
    self.state = UIGestureRecognizerStateBegan;
  } else if (self.state == UIGestureRecognizerStateBegan) {
    self.state = UIGestureRecognizerStateChanged;
  }
}

// é‡è½½ UIGestureRecognizer çš„ touchesMoved æ–¹æ³•
- (void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
  // è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œä¿è¯ IOS çš„äº‹ä»¶ç³»ç»ŸåŒæ­¥åˆ°äº†è¿™ä¸ªäº‹ä»¶ï¼ˆå¦åˆ™å°±è¢«æ‹¦æˆªåœ¨è¿™é‡Œäº†ï¼‰
  [super touchesMoved:touches withEvent:event];

	// å°† touchMove äº‹ä»¶åŒ…è£…åå‘é€ç»™ js ä¾§
  [self _updateAndDispatchTouches:touches eventName:@"touchMove"];
	// ä¿è¯ IOS Recognizer çŠ¶æ€æœºçš„æ­£å¸¸æµè½¬
  self.state = UIGestureRecognizerStateChanged;
}

// é‡è½½ UIGestureRecognizer çš„ touchesEnded æ–¹æ³•
- (void)touchesEnded:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
  [super touchesEnded:touches withEvent:event];

	// å°† touchEnd äº‹ä»¶åŒ…è£…åå‘é€ç»™ js ä¾§
  [self _updateAndDispatchTouches:touches eventName:@"touchEnd"];

	// ä¿è¯ IOS Recognizer çŠ¶æ€æœºçš„æ­£å¸¸æµè½¬
  if (RCTAllTouchesAreCancelledOrEnded(event.allTouches)) {
    self.state = UIGestureRecognizerStateEnded;
  } else if (RCTAnyTouchesChanged(event.allTouches)) {
    self.state = UIGestureRecognizerStateChanged;
  }
	// ...çœç•¥éƒ¨ä»½ä»£ç 
}

// é‡è½½ UIGestureRecognizer çš„ touchesCancelled æ–¹æ³•
- (void)touchesCancelled:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
  [super touchesCancelled:touches withEvent:event];

	// å°† touchEnd äº‹ä»¶åŒ…è£…åå‘é€ç»™ js ä¾§
  [self _updateAndDispatchTouches:touches eventName:@"touchCancel"];

	// ä¿è¯ IOS Recognizer çŠ¶æ€æœºçš„æ­£å¸¸æµè½¬
  if (RCTAllTouchesAreCancelledOrEnded(event.allTouches)) {
    self.state = UIGestureRecognizerStateCancelled;
  } else if (RCTAnyTouchesChanged(event.allTouches)) {
    self.state = UIGestureRecognizerStateChanged;
  }
  // ...çœç•¥éƒ¨ä»½ä»£ç 
}
```

æ ¹æ®ä¸Šé¢ `RCTTouchHandler.m` çš„å®ç°æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„äº‹ä»¶å›è°ƒéƒ½åŒ…å«ä¸‰ä¸ªéƒ¨ä»½çš„å†…å®¹ï¼š

1. è°ƒç”¨çˆ¶ç±»çš„åŒåæ–¹æ³•ï¼šè¿™ä¸ªæ˜¯ IOS ç³»ç»Ÿè¦æ±‚çš„ï¼Œå› ä¸º UIGestureRecognizer è¿˜ä¼šè´Ÿè´£åè°ƒä¸åŒçš„ Recognizerï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è·Ÿå®ƒåŒæ­¥æœ€æ–°çš„æ¶ˆæ¯
2. å°†å½“å‰äº‹ä»¶æ‰“åŒ…åå‘é€ç»™ JS ä¾§
3. æ­£å¸¸æµè½¬çŠ¶æ€ï¼šåœ¨ UIGestureRecognizer è¿™ä¸ªç±»ä¸­æ˜¯æ²¡æœ‰çŠ¶æ€æµè½¬çš„é€»è¾‘çš„ï¼Œè¿™äº›çŠ¶æ€çš„å˜åŒ–éƒ½è¦ä»°èµ–å­ç±»çš„ç»´æŠ¤ï¼Œè€Œ UIKit ä¼šæ ¹æ®è¿™ä¸ªçŠ¶æ€æ¥åˆ¤æ–­/æ‰§è¡Œä¸€äº›é€»è¾‘ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜¯å¿…é¡»å®ç°çš„

æœ€åè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå‰é¢æˆ‘ä»¬åœ¨èŠ UIGestureRecognizer çš„çŠ¶æ€çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´è¿‡ç‚¹å‡»å±äºç¦»æ•£å‹æ‰‹åŠ¿ï¼Œå®ƒçš„ç‰¹å¾å°±æ˜¯æ‰‹åŠ¿çš„çŠ¶æ€æ˜¯ `Possible -> Recognized/Failed`

ä½†æ˜¯æˆ‘ä»¬ä»”ç»†è§‚å¯Ÿ RCTTouchHandler çš„å®ç°ï¼Œä¸éš¾å‘ç°å®ƒçš„çŠ¶æ€æµè½¬æ˜¯ `Possible -> Begin -> [Changed] -> Ended/Cancel`

è¿™æ˜¯å› ä¸ºè¿™ä¸ªç±»çš„ç›®çš„æ˜¯å¤„ç†æ‰€æœ‰çš„ Touch äº‹ä»¶ï¼Œæ‰€ä»¥å®ƒå¿…é¡»å‘ JS ä¾§å®Œæ•´çš„ä¼ é€’æ‰€æœ‰äº‹ä»¶ï¼Œç”± JS ä¾§æ¥åˆ¤æ–­äº‹ä»¶çš„ç±»å‹

è‡³æ­¤ï¼ŒIOS ä¾§çš„å·¥ä½œä¹Ÿå·²å®Œç»“æ’’èŠ±ï½ğŸ‰

### JS ä¾§

æœ€åï¼Œæˆ‘ä»¬æ¥èŠèŠ JS ä¾§æ˜¯å¦‚ä½•å¤„ç†åŒç«¯å‘æ¥çš„äº‹ä»¶æ¶ˆæ¯çš„

åœ¨ JS ä¾§ï¼ŒRN å¯¹å¤–å®šä¹‰äº†ä¸€ä¸ªåä¸º `RCTEventEmitter` çš„æ¨¡å—æ¥æ¥æ”¶å®¢æˆ·ç«¯ä¼ æ¥çš„äº‹ä»¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ bridge è°ƒç”¨å…¶ä¸­çš„ `receiveTouches` æ–¹æ³•æ¥å‘é€è§¦æ‘¸äº‹ä»¶ç»™ JS ä¾§























## å‚è€ƒèµ„æ–™

- [iOS çš„å“åº”é“¾å°ç»“](https://juejin.cn/post/7005112607707398157)
- [æ·±å…¥ç†è§£ iOS äº‹ä»¶æœºåˆ¶](https://juejin.cn/post/6844903905080410125)
- [Event Handling Guide for iOS](https://github.com/BladeTail/Event-Handling-Guide-for-iOS/blob/master/Event%20Handling%20Guide%20for%20iOS.pdf)





react-native-gesture-handler