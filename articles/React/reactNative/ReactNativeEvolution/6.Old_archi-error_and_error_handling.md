# RN çš„è¿è¡Œæ—¶å¼‚å¸¸ä¸å¼‚å¸¸æ•è·å¤„ç†

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥èŠèŠ RN æ˜¯å¦‚ä½•å¤„ç†è¿è¡Œæ—¶å¼‚å¸¸çš„

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆè€ƒè™‘ä¸‹å¼‚å¸¸çš„æ¥æº

ç”±äº RN æ˜¯ä¸€ä¸ªè·¨è¯­è¨€è·¨ç«¯çš„æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®å¼‚å¸¸çš„æ¥æºåˆ’åˆ†ä¸ºï¼š

- JS ä¾§çš„å¼‚å¸¸ï¼š`ReferenceError`ï¼Œ `TypeError` ç­‰ç­‰
- ç«¯ä¾§çš„å¼‚å¸¸ï¼šIOS çš„ `NSException`ï¼ŒAndroid çš„ `RuntimeException` ç­‰ç­‰

å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¼‚å¸¸è¯¥ç”±è°æ¥å¤„ç†ï¼š

- åœ¨æµè§ˆå™¨ä¸­ï¼Œæœªæ•è·çš„å¼‚å¸¸æœ€åä¼šè¢« JS è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚ V8ï¼‰å…œä½ï¼Œæœ€åäº¤ç»™å®¿ä¸»å¹³å°ï¼ˆæµè§ˆå™¨ï¼‰å¤„ç†
- åœ¨ RN ä¸­ï¼Œé€»è¾‘ç±»ä¼¼ï¼Œä¹Ÿéœ€è¦æœ‰ä¸€å¥—é€»è¾‘æŠŠæœªæ•è·å¼‚å¸¸äº¤ç»™**åŸç”Ÿå¹³å°ï¼ˆIOSï¼ŒAndroidï¼‰å¤„ç†**

ä¸ºäº†åšåˆ°è¿™ä»¶äº‹ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. åœ¨ JS ä¾§æ”¶é›†æœªæ•è·å¼‚å¸¸ï¼Œå¹¶å‘é€ç»™ Native
2. åœ¨ Native ä¸­æŒ‰ç…§å¹³å°ç‰¹æ€§å¤„ç†è¿™äº›å¼‚å¸¸

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥ RN å†…éƒ¨ï¼Œä¸€èµ·è®¨è®º RN æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸¤ä»¶äº‹çš„

## JS ä¾§

### åŒæ­¥å¼‚å¸¸

JS ä¾§åœ¨å¼‚å¸¸å¤„ç†ä¸­æœ€é‡è¦çš„èŒè´£å°±æ˜¯**å°½å¯èƒ½çš„æ”¶é›†æ‰€æœ‰æœªæ•è·å¼‚å¸¸ï¼Œç„¶åå‘é€ç»™ Native**

æˆ‘ä»¬éƒ½çŸ¥é“å®é™…ä¸Š RN å°±æ˜¯ä¸€ä¸ª `Native-Bridge-JS` çš„ä¸‰å±‚æ¶æ„ï¼Œè€Œ JS ä¸­æ‰€æœ‰ä»£ç çš„è§¦å‘éƒ½æ¥æºäº Native çš„è°ƒç”¨

åœ¨ JS ä¸­ï¼Œæ‰€æœ‰æ¥è‡ª Native çš„è°ƒç”¨éƒ½ä¼šé›†ä¸­åœ¨ `MessageQueue.js` ä¸­ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ”¶é›†æœªæ•è·å¼‚å¸¸çš„å¥½æ—¶æœº

äº‹å®ä¸Šï¼ŒRN ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ `MessageQueue.js` ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼š
```js
// in MessageQueue.js
class MessageQueue {
  // ...çœç•¥è‹¥å¹²ä»£ç 
  
  // Native è°ƒç”¨ JS æ¨¡å—æ–¹æ³•
	callFunctionReturnFlushedQueue(module: string, method: string, args: any[]) {
    this.__guard(() => {
      this.__callFunction(module, method, args);
    });

    return this.flushedQueue();
  }

	// Native è°ƒç”¨ JS æ¨¡å—æ–¹æ³•å¹¶è¿”å›ç»“æœ
  callFunctionReturnResultAndFlushedQueue(
    module: string,
    method: string,
    args: any[],
  ) {
    let result;
    this.__guard(() => {
      result = this.__callFunction(module, method, args);
    });

    return [result, this.flushedQueue()];
  }

	// Native è°ƒç”¨ JS æ¨¡å—å›è°ƒ
  invokeCallbackAndReturnFlushedQueue(cbID: number, args: any[]) {
    this.__guard(() => {
      this.__invokeCallback(cbID, args);
    });

    return this.flushedQueue();
  }

	/**
   * Private methods
   */
  __guard(fn: () => void) {
    // ç”¨äºå†…éƒ¨è°ƒè¯•ï¼Œå¯ä»¥æš‚æ—¶å¿½ç•¥
    if (this.__shouldPauseOnThrow()) {
      fn();
    } else {
      // é‡ç‚¹çœ‹è¿™é‡Œ
      try {
        fn();
      } catch (error) {
        ErrorUtils.reportFatalError(error);
      }
    }
  }

	// ...çœç•¥è‹¥å¹²ä»£ç 
}
```

å¯ä»¥çœ‹åˆ°è¿™ä¸‰ä¸ª Native è°ƒç”¨ JS æ¨¡å—çš„æ–¹æ³•éƒ½ä½¿ç”¨äº† `this.__guard` æ¥åŒ…è£¹

åœ¨ `__guard` ä¸­åšäº†ä¸€ä»¶äº‹ï¼š**æ•è·è°ƒç”¨è¿‡ç¨‹ä¸­çš„æœªæ•è·å¼‚å¸¸ï¼Œå¹¶ä¸”å°†å…¶äº¤ç»™ `ErrorUtils` æ¨¡å—çš„ `reportFatalError` æ–¹æ³•å¤„ç†**

æˆ‘ä»¬æ¥çœ‹çœ‹ `ErrorUtils` éƒ½åšäº†äº›ä»€ä¹ˆï¼š

```js
// error-guard.js
const ErrorUtils = {
  setGlobalHandler(fun) {
    _globalHandler = fun;
  },
  getGlobalHandler() {
    return _globalHandler;
  },
  // ä¸ŠæŠ¥éè‡´å‘½å¼‚å¸¸
  reportError(error) {
    _globalHandler && _globalHandler(error);
  },
  // ä¸ŠæŠ¥è‡´å‘½å¼‚å¸¸
  reportFatalError(error) {
    _globalHandler && _globalHandler(error, true);
  },
  
  // ...çœç•¥éƒ¨ä»½ä»£ç 
};
```

å¯ä»¥çœ‹åˆ°ï¼Œ`ErrorUtils` åªæ˜¯å¸®å¿™æŒæœ‰äº† `_globalHandler`ï¼Œå¹¶ä¸”åœ¨ä¸­é—´åšäº†ä¸€å±‚è½¬å‘è€Œå·²

è€ŒçœŸæ­£çš„ handler åœ¨é¡¹ç›®åˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»è¢«æ³¨å…¥äº†ï¼š

```js
// in InitializeCore.js

// ...çœç•¥éƒ¨ä»½ä»£ç 
// Set up console
const ExceptionsManager = require('ExceptionsManager');
ExceptionsManager.installConsoleErrorReporter();

// Set up error handler
if (!global.__fbDisableExceptionsManager) {
  const handleError = (e, isFatal) => {
    try {
      ExceptionsManager.handleException(e, isFatal);
    } catch (ee) {
      console.log('Failed to print error: ', ee.message);
      throw e;
    }
  };

  const ErrorUtils = require('ErrorUtils');
  ErrorUtils.setGlobalHandler(handleError);
}

// ...çœç•¥éƒ¨ä»½ä»£ç 
```

æˆ‘ä»¬ç»ˆäºæ‰¾åˆ°äº†æºå¤´ï¼š`ExceptionsManager` å°±æ˜¯è´Ÿè´£å¤„ç†å¼‚å¸¸çš„æ ¸å¿ƒæ¨¡å—

`ExceptionsManager` å†…éƒ¨ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

1. æŠŠå¼‚å¸¸åˆ†æˆäº†ä¸¤ç§ï¼šè‡´å‘½ä¸éè‡´å‘½ï¼ˆisFatalï¼‰ï¼Œå¹¶ä¸”å°†å…¶å‘é€ç»™äº†ä¸åŒçš„ Native å¤„ç†æ–¹æ³•
2. ç»™åŸæ¥çš„ `console.error` åŠ äº†ä¸ªè£…é¥°å™¨ï¼Œä»¥éè‡´å‘½çš„å½¢å¼å°† error çš„å†…å®¹å‘ç»™äº† Native

```js
// in ExceptionsManager.js

// ...çœç•¥éƒ¨ä»½ä»£ç 
function reportException(e: ExtendedError, isFatal: boolean) {
  const {ExceptionsManager} = require('NativeModules');
  if (ExceptionsManager) {
    const parseErrorStack = require('parseErrorStack');
    const stack = parseErrorStack(e);
    const currentExceptionID = ++exceptionID;
    // æ ¹æ®å¼‚å¸¸çš„ä¸¥é‡ç¨‹åº¦è°ƒç”¨ä¸åŒçš„ Native å¤„ç†æ–¹æ³•
    if (isFatal) {
      ExceptionsManager.reportFatalException(
        e.message,
        stack,
        currentExceptionID,
      );
    } else {
      ExceptionsManager.reportSoftException(
        e.message,
        stack,
        currentExceptionID,
      );
    }
    // ...çœç•¥éƒ¨ä»½ä»£ç 
  }
}

// console.error çš„è£…é¥°å™¨
function reactConsoleErrorHandler() {
  console._errorOriginal.apply(console, arguments);
  if (!console.reportErrorsAsExceptions) {
    return;
  }

  if (arguments[0] && arguments[0].stack) {
    reportException(arguments[0], /* isFatal */ false);
  } else {
    const stringifySafe = require('stringifySafe');
    const str = Array.prototype.map.call(arguments, stringifySafe).join(', ');

    // ... çœç•¥éƒ¨ä»½ä»£ç 

    const error: ExtendedError = new Error('console.error: ' + str);
    error.framesToPop = 1;
    // å‘é€éè‡´å‘½å¼‚å¸¸ç»™ Native
    reportException(error, /* isFatal */ false);
  }
}

// åœ¨ä¸Šè¿° InitializeCore.js ä¸­è¢«è°ƒç”¨çš„æ–¹æ³•ï¼ŒèŒè´£æ˜¯ç»™ console.error åŠ è£…é¥°å™¨
function installConsoleErrorReporter() {
  // Enable reportErrorsAsExceptions
  if (console._errorOriginal) {
    return; // already installed
  }
  // Flow doesn't like it when you set arbitrary values on a global object
  console._errorOriginal = console.error.bind(console);
  console.error = reactConsoleErrorHandler;
  if (console.reportErrorsAsExceptions === undefined) {
    // Individual apps can disable this
    // Flow doesn't like it when you set arbitrary values on a global object
    console.reportErrorsAsExceptions = true;
  }
}
```

ä¹‹æ‰€ä»¥è¦åŒºåˆ†è‡´å‘½/éè‡´å‘½å¼‚å¸¸ï¼Œæ˜¯å› ä¸º RN å¸Œæœ›å¼€å‘è€…èƒ½åœ¨ DEV æ¨¡å¼ä¸‹è·å¾—æ›´å¤šä¿¡æ¯ï¼Œè¿™ä¸¤ç§å¼‚å¸¸åœ¨ PROD/DEV æ¨¡å¼ä¸‹çš„è¡¨ç°å¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š

|      | è‡´å‘½å¼‚å¸¸                  | éè‡´å‘½å¼‚å¸¸          |
| ---- | ------------------------- | ------------------- |
| DEV  | RedBoxï¼ˆçº¢å±ï¼‰ + åº”ç”¨ç»ˆæ­¢ | RedBox / LogBox     |
| PROD | åº”ç”¨é—ªé€€                  | æ‰“å°æ—¥å¿— / å¿½ç•¥å¼‚å¸¸ |

è‡´å‘½å¼‚å¸¸çš„å…¸å‹ç‰¹å¾æ˜¯**ä»è¢«è°ƒç”¨çš„ JS æ–¹æ³•çš„è¾¹ç•Œé€ƒé€¸å‡ºå»**ï¼Œæ¯”å¦‚ï¼š

- ç»„ä»¶å†…éƒ¨æŠ›å‡ºå¼‚å¸¸ä½†æ˜¯æ²¡æœ‰è®¾ç«‹ ErrorBoundary
- AppRegistry.runApplication å†…éƒ¨æŠ›å‡ºçš„æœªæ•è·å¼‚å¸¸

æ­¤æ—¶æˆ‘ä»¬åº”è¯¥åšçš„å°±æ˜¯ï¼š**ç«‹åˆ»ç»ˆæ­¢å½“å‰åº”ç”¨**

<br />

éè‡´å‘½å¼‚å¸¸æŒ‡çš„æ˜¯é‚£äº›æ²¡æœ‰ä» JS æ–¹æ³•è¾¹ç•Œé€ƒé€¸çš„è½¯æ€§å¼‚å¸¸ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ `console.error`ï¼Œè¿™ç±»å¼‚å¸¸ä»…ä½œä¸ºè­¦å‘Šä½œç”¨ï¼Œé€šå¸¸ä¸ä¼šå½±å“ç¨‹åºè¿è¡Œ

### å¼‚æ­¥å¼‚å¸¸

åœ¨ JS ä¸­è¿˜æœ‰ä¸€ç±»å¼‚å¸¸ï¼Œå®ƒä»¬ä¸ä¼šç›´æ¥çš„å½±å“ç¨‹åºå¯ç”¨æ€§ï¼Œä½†æ˜¯å®ƒä»¬ä¸€æ—¦å‡ºç°ï¼Œä¸€èˆ¬æ ‡è¯†ç€ä¸å¤ªå¥½çš„ä¿¡å·

è¿™ç±»å¼‚å¸¸æœ‰æ—¶ç”šè‡³æ¯”ç›´æ¥å´©æºƒçš„å±å®³æ›´å¤§ï¼Œå› ä¸ºå®ƒå¾€å¾€æ˜¯é™é»˜çš„ï¼Œç”šè‡³å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å¶ç°é—®é¢˜

è¿™å°±æ˜¯å¼‚æ­¥å¼‚å¸¸

ä¸ºäº†ä¾¦æµ‹è¿™ç±»å¼‚å¸¸ï¼Œæµè§ˆå™¨æä¾›äº† `unhandledrejection` äº‹ä»¶æˆ– `onunhandledrejection` å±æ€§æ¥è®©å¼€å‘è€…ç›‘æ§æ­¤ç±»å¼‚å¸¸ï¼Œå…¶ç”¨æ³•å¦‚ä¸‹ï¼š

```js
window.addEventListener("unhandledrejection", (event) => {
  console.warn(`UNHANDLED PROMISE REJECTION: ${event.reason}`);
});

window.onunhandledrejection = (event) => {
  console.warn(`UNHANDLED PROMISE REJECTION: ${event.reason}`);
};
```

è€Œåœ¨ RN ä¸­ï¼Œæ˜¯æ²¡æœ‰è¿™äº›äº‹ä»¶ä¸å±æ€§çš„ï¼Œæ‰€ä»¥ RN é‡‡å–äº†æ›²çº¿æ•‘å›½çš„æ–¹æ³•ï¼šä½¿ç”¨ä¸€ä¸ª polyfill çš„ Promiseï¼ˆç›¸å…³ [Repo](https://github.com/then/promise/tree/master)ï¼‰

RN åœ¨ `InitializeCore.js` ä¸­ä½¿ç”¨äº†æ–°çš„ Promise è¦†ç›–äº†åŸæ¥çš„ï¼š

```js
// in InitializeCore.js

// Set up Promise
// The native Promise implementation throws the following error:
// ERROR: Event loop not supported.
polyfillGlobal('Promise', () => require('Promise'));
```

è¿™ä¸ª Promise æ¥è‡ª `Libraries/Promise.js`ï¼š

```js
// in Promise.js

// è¿™ä¸ªæ–‡ä»¶ fork äº† https://github.com/then/promise/tree/master
const Promise = require('fbjs/lib/Promise.native');

if (__DEV__) {
  // è¿™é‡Œä½¿ç”¨äº†ä¸Šè¿° promise ä»“åº“ä¸­çš„å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨æä¾›çš„åŸå§‹ Promise åé¢æŒ‚äº†ä¸€ä¸ªé’ˆå¯¹ reject çš„ç›‘å¬
  // æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ https://github.com/then/promise/blob/master/src/rejection-tracking.js#L20
  require('promise/setimmediate/rejection-tracking').enable({
    allRejections: true,
    onUnhandled: (id, error = {}) => {
      let message: string;
      let stack: ?string;

      const stringValue = Object.prototype.toString.call(error);
      if (stringValue === '[object Error]') {
        message = Error.prototype.toString.call(error);
        stack = error.stack;
      } else {
        message = require('pretty-format')(error);
      }

      const warning =
        `Possible Unhandled Promise Rejection (id: ${id}):\n` +
        `${message}\n` +
        (stack == null ? '' : stack);
      console.warn(warning);
    },
    onHandled: id => {
      const warning =
        `Promise Rejection Handled (id: ${id})\n` +
        'This means you can ignore any previous messages of the form ' +
        `"Possible Unhandled Promise Rejection (id: ${id}):"`;
      console.warn(warning);
    },
  });
}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ RN polifill çš„ Promise ä¸­ï¼Œé’ˆå¯¹æœªè¢«æ•è·çš„ reject åšäº†ä¸€ä¸ª `console.warn` çš„æ“ä½œ

é‡‡å–äº†ä¸€ä¸ª â€œæé†’ä½†ä¸å¹²æ‰°â€ çš„è§£å†³æ–¹æ¡ˆ

<br />

è‡³æ­¤ï¼ŒJS ä¾§çš„å¼‚å¸¸å¤„ç†èŒè´£ç»“æŸï¼Œè¯¥è½®åˆ° Native æ¥é”…äº†

## Native ä¾§

### Android

åœ¨ Android ä¸­ï¼Œé’ˆå¯¹å¼‚å¸¸å¤„ç†ä¸»è¦æœ‰ä¸¤ä¸ªèŒè´£ï¼š

- å¤„ç† JS ä¼ è¿‡æ¥çš„è‡´å‘½/éè‡´å‘½å¼‚å¸¸
- å¤„ç† Native module æ‰§è¡Œè¿‡ç¨‹çš„å¼‚å¸¸

<br />

é¦–å…ˆæ¥çœ‹å¯¹ JS ä¾§ä¼ æ¥å¼‚å¸¸çš„å¤„ç†

JS çš„å¼‚å¸¸æ˜¯ç”± ExceptionsManagerModule è´Ÿè´£å¤„ç†ï¼Œå®ƒå¯¹ JS æš´éœ²äº†ä¸¤ä¸ªæ–¹æ³•ï¼š`reportFatalException` ä¸ `reportSoftException`

```java
// in ExceptionsManagerModule.java

@ReactModule(name = ExceptionsManagerModule.NAME)
public class ExceptionsManagerModule extends BaseJavaModule {
  protected static final String NAME = "ExceptionsManager";

  @ReactMethod
  public void reportFatalException(String title, ReadableArray details, int exceptionId) {
    // å¤„ç†è‡´å‘½å¼‚å¸¸
    showOrThrowError(title, details, exceptionId);
  }

  @ReactMethod
  public void reportSoftException(String title, ReadableArray details, int exceptionId) {
    // å¤„ç†éè‡´å‘½å¼‚å¸¸
    if (mDevSupportManager.getDevSupportEnabled()) {
      mDevSupportManager.showNewJSError(title, details, exceptionId);
    } else {
      FLog.e(ReactConstants.TAG, JSStackTrace.format(title, details));
    }
  }

  private void showOrThrowError(String title, ReadableArray details, int exceptionId) {
    if (mDevSupportManager.getDevSupportEnabled()) {
      mDevSupportManager.showNewJSError(title, details, exceptionId);
    } else {
      // æŠ›å‡ºåŸç”Ÿ JavascriptException
      throw new JavascriptException(JSStackTrace.format(title, details));
    }
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ ExceptionsManagerModule å†…éƒ¨çš„æ–¹æ³•è¿˜é’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼ˆDEV/PRODï¼‰åŒºåˆ†äº†ä¸åŒçš„åº”å¯¹æƒ…å†µ

å…¶ä¸­ `mDevSupportManager.showNewJSError` æœ¬è´¨ä¸Šå°±æ˜¯è°ƒå‡º RedBox

å¦‚æœå½“å‰åœ¨ PROD åœºæ™¯ä¸”å‘ç”Ÿäº†è‡´å‘½å¼‚å¸¸ï¼ŒExceptionsManagerModule åˆ™ä¼šç›´æ¥å‘å¤–æŠ›å‡ºä¸€ä¸ª `JavascriptException`ï¼ˆç¬¬ 27 è¡Œï¼‰

è¿™ä¸ªå¼‚å¸¸åœ¨æ²¡æœ‰é¢å¤–çš„å¹²é¢„ä¸‹ï¼Œä¼šå¯¼è‡´åº”ç”¨é—ªé€€

<br />

æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ Native module å¦‚æœå‘ç”Ÿå¼‚å¸¸è¯¥æ€ä¹ˆå¤„ç†

æˆ‘ä»¬å…ˆæ”¾ä¸€ä¸ªæµç¨‹å›¾ï¼Œåé¢ä¼šè¯¦ç»†è¯´æ˜ï¼š

```bash
  JS è°ƒç”¨ Native module
â†’ RN æ‰¾åˆ° Native module å¯¹åº”çš„çº¿ç¨‹ï¼Œå¹¶ä¸”å‘é€è°ƒç”¨ä¿¡æ¯ï¼ˆé€šè¿‡ dispatchMessage å‘é€ï¼‰
â†’ RN ç”¨ MessageQueueThreadHandler é‡è½½äº† dispatchMessage æ–¹æ³•ï¼Œæ¤å…¥äº†ä¸€ä¸ª try-catch
â†’ Native module å‡ºç°å¼‚å¸¸ï¼Œè¢« catch æ•è·åè¢« NativeExceptionHandler çš„ handleException æ¶ˆè´¹
â†’ handleException åšäº†ä¸¤ä»¶äº‹ï¼š
	1. è°ƒç”¨ NativeModuleCallExceptionHandler çš„ handleException æ–¹æ³•
	2. è°ƒç”¨ UI çº¿ç¨‹ä¸­çš„ destroy æ–¹æ³•æ‹†æ‰ RN è¿è¡Œæ—¶
â†’ å¦‚æœ handleException ä¸­é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œæ•´ä¸ª APP ä¼šé—ªé€€ï¼›å¦åˆ™ï¼Œæ•´ä¸ª APP ä¼šåªå‰©ä¸‹ç©ºå£³ï¼ˆå› ä¸º RN è¿è¡Œæ—¶è¢«æ‹†äº†ï¼‰
```

åœ¨æœ¬ä¸“æ çš„å‰æ–‡æœ‰è¯´è¿‡ï¼ŒRN çš„ä¸åŒ Native module åœ¨ Android ä¸­å–å†³äºå…·ä½“é…ç½®æœ‰å¯èƒ½å­˜åœ¨äºä¸åŒçš„çº¿ç¨‹ä¸­

æ‰€ä»¥ä» JS åˆ° Native module çš„è°ƒç”¨åŠ¿å¿…éœ€è¦ç»è¿‡è·¨çº¿ç¨‹çš„æµç¨‹ï¼Œè€Œ RN é€šè¿‡é‡è½½å…¶ä¸­çš„å…³é”®æ–¹æ³•ï¼ŒæŠŠæ‰€æœ‰ Native module å‡ºç°çš„å¼‚å¸¸å…¨éƒ¨å…œä½äº†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```java
// in MessageQueueThreadHandler.java

/**
 * Handler that can catch and dispatch Exceptions to an Exception handler.
 */
public class MessageQueueThreadHandler extends Handler {

  private final QueueThreadExceptionHandler mExceptionHandler;

  public MessageQueueThreadHandler(Looper looper, QueueThreadExceptionHandler exceptionHandler) {
    super(looper);
    mExceptionHandler = exceptionHandler;
  }

  @Override
  public void dispatchMessage(Message msg) {
    try {
      super.dispatchMessage(msg);
    } catch (Exception e) {
      // å…³é”®ï¼ŒæŠŠæ‰€æœ‰ Native module çš„é€»è¾‘éƒ½ç”¨ try-catch åŒ…ä½äº†å¹¶å§”æ‰˜ç»™ mExceptionHandler
      mExceptionHandler.handleException(e);
    }
  }
}

```

å…¶ä¸­ handleException çš„å®ç°è¢«æ”¾åœ¨äº† `CatalystInstanceImpl.java` ä¸­ï¼ˆè¿™ä¸ªæ–‡ä»¶ä¸»è¦ç®¡ Android ä¾§çš„ bridge è¿è¡Œæ—¶ï¼‰

```js
// in CatalystInstanceImpl.java

public class CatalystInstanceImpl implements CatalystInstance {
  // ...çœç•¥éƒ¨ä»½ä»£ç 
  private void onNativeException(Exception e) {
    // è°ƒç”¨ NativeModuleCallExceptionHandler çš„å¼‚å¸¸å¤„ç†æ–¹æ³•
    mNativeModuleCallExceptionHandler.handleException(e);
    // è°ƒç”¨ UI çº¿ç¨‹çš„ destroy æ–¹æ³•ï¼ŒæŠŠ RN è¿è¡Œæ—¶æ‹†æ‰
    mReactQueueConfiguration.getUIQueueThread().runOnQueue(
      new Runnable() {
        @Override
        public void run() {
          destroy();
        }
      });
  }

  private class NativeExceptionHandler implements QueueThreadExceptionHandler {
    @Override
    public void handleException(Exception e) {
      onNativeException(e);
    }
  }
	// ...çœç•¥éƒ¨ä»½ä»£ç 
}
```

`NativeModuleCallExceptionHandler` éå¸¸æœ‰æ„æ€ï¼Œå› ä¸ºå®ƒæ˜¯ RN APP å¼€å‘è€…åœ¨ RN æ¡†æ¶èŒƒç•´å†…å”¯ä¸€èƒ½æ„ŸçŸ¥åˆ° Native module å¼‚å¸¸çš„æœºåˆ¶ï¼Œè¦è®¤è¯†å¦‚ä½•ä½¿ç”¨ `NativeModuleCallExceptionHandler`ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ `ReactInstanceManager`

`ReactInstanceManager` ä¸»è¦è´Ÿè´£ Android ä¸­å…³äº RN çš„æ‰€æœ‰è¿è¡Œæ—¶ç®¡ç†ï¼ŒåŒ…æ‹¬ JS å¼•æ“ã€Bridgeã€JS bundle åŠ è½½ã€é”™è¯¯å¤„ç†ç­‰ç­‰

ä¸Šé¢æˆ‘ä»¬è¯´æŠŠè¿è¡Œæ—¶æ‹†æ‰çš„ destroy æ–¹æ³•çš„å®ç°ä¹Ÿåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­

`ReactInstanceManager` éœ€è¦é€šè¿‡ `ReactInstanceManagerBuilder` æ„å»ºï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå…¬å…±æ–¹æ³• `setNativeModuleCallExceptionHandler`ï¼Œè¿™ä¸ªæ–¹æ³•è´Ÿè´£è®¾ç½®ä¸€ä¸ªå¤„ç†æ‰€æœ‰ Native module æŠ›å‡ºæ¥å¼‚å¸¸çš„æ–¹æ³•

RN APP çš„å¼€å‘è€…å¯ä»¥é€šè¿‡åœ¨è‡ªå·±é¡¹ç›®çš„ `MainApplication.java` ä¸­é‡è½½ `createReactInstanceManager` æ–¹æ³•æ¥å®šåˆ¶ä¸€ä¸ªè‡ªå·±çš„ `NativeModuleCallExceptionHandler`ï¼š

```js
// in MainApplication.java(Your repo)

public class MainApplication extends Application implements ReactApplication {

  private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {
    @Override
    protected ReactInstanceManager createReactInstanceManager() {
      ReactInstanceManagerBuilder builder =
          ReactInstanceManager.builder()
              .setApplication(getApplication())
              .setCurrentActivity(null)
              .setBundleAssetName("index.android.bundle")
              .setJSMainModulePath("index")
              .addPackages(getPackages())
              .setUseDeveloperSupport(getUseDeveloperSupport())
              .setInitialLifecycleState(LifecycleState.BEFORE_CREATE);

      builder.setNativeModuleCallExceptionHandler(e -> {
        // å¯ä»¥åœ¨è¿™é‡Œæ‰“å°æ—¥å¿—ã€å±•ç¤ºå¼‚å¸¸ uiã€é‡å¯åº”ç”¨ç­‰ç­‰
        // æ³¨æ„å¦‚æœåœ¨è¿™é‡Œåæ‰äº†å¼‚å¸¸ï¼ŒAndroid ä¾ç„¶ä¼šæŠŠ RN ç›¸å…³çš„è¿è¡Œæ—¶æ‹†æ‰ï¼Œæ•´ä¸ª APP ä¼šåªå‰©ä¸‹ä¸€ä¸ªç©ºå£³
        // å¦‚æœè¿™é‡Œæ­£å¸¸æŠŠå¼‚å¸¸å†åº¦æŠ›å‡ºï¼Œåœ¨æ²¡æœ‰ç‰¹åˆ«è®¾ç½®çš„æƒ…å†µä¸‹ä¼šä½¿åº”ç”¨é—ªé€€ï¼ˆåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªç»“æœæœ‰æ—¶æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼‰
      });

      return builder.build();
    }

    // ...çœç•¥éƒ¨ä»½ä»£ç 
  };

  // ...çœç•¥éƒ¨ä»½ä»£ç 
}

```

æ—¢ç„¶æˆ‘ä»¬å¯ä»¥è¦†ç›–ï¼Œé‚£å°±è¡¨ç¤ºæœ‰é»˜è®¤çš„å®ç°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ RN é»˜è®¤çš„ `NativeModuleCallExceptionHandler` åšäº†å“ªäº›æ“ä½œ

```js
// in DevSupportManagerImpl.java

// ...çœç•¥éƒ¨ä»½ä»£ç 
@Override
public void handleException(Exception e) {
  // å¦‚æœå¼€å‘æ¨¡å¼æ‰“å¼€äº†
  if (mIsDevSupportEnabled) {
    // åªæ‰“å°æ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶ APP ä¸ä¼šé—ªé€€ï¼Œä½†æ˜¯ä¼šåªå‰©ä¸€ä¸ªç©ºå£³å­
    for (ExceptionLogger logger : mExceptionLoggers) {
      logger.log(e);
    }
  } else {
    // è¿™éƒ¨åˆ†ä»£ç åœ¨ä¸‹é¢çš„ DefaultNativeModuleCallExceptionHandler.java ä¸­
    mDefaultNativeModuleCallExceptionHandler.handleException(e);
  }
}
// ...çœç•¥éƒ¨ä»½ä»£ç 

// in DefaultNativeModuleCallExceptionHandler.java

// ...çœç•¥éƒ¨ä»½ä»£ç 
public class DefaultNativeModuleCallExceptionHandler implements NativeModuleCallExceptionHandler {
  @Override
  public void handleException(Exception e) {
    // ç›´æ¥æŠŠå¼‚å¸¸åŸå°ä¸åŠ¨æŠ›å‡ºå»äº†ï¼Œæ­¤æ—¶åº”ç”¨ä¼šç›´æ¥é—ªé€€
    if (e instanceof RuntimeException) {
      throw (RuntimeException) e;
    } else {
      throw new RuntimeException(e);
    }
  }
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬èŠå®Œäº† Android çš„éƒ¨ä»½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬èŠèŠ IOS çš„éƒ¨ä»½

### IOS

ä¸ Android ç±»ä¼¼ï¼ŒIOS é’ˆå¯¹å¼‚å¸¸å¤„ç†ä¹Ÿæœ‰å¯¹ç§°çš„ä¸¤ä¸ªèŒè´£ï¼š

- å¤„ç† JS ä¼ è¿‡æ¥çš„è‡´å‘½/éè‡´å‘½å¼‚å¸¸
- å¤„ç† Native module æ‰§è¡Œè¿‡ç¨‹çš„å¼‚å¸¸

<br />

é¦–å…ˆæ¥çœ‹å¯¹ JS ä¾§ä¼ æ¥å¼‚å¸¸çš„å¤„ç†ï¼šä¸ Android ç±»ä¼¼ï¼ŒIOS ä¹Ÿæœ‰ä¸€ä¸ªé’ˆå¯¹ JS å¼‚å¸¸çš„ Native module

```objc
// in RCTExceptionsManager.m

// å¤„ç†éè‡´å‘½å¼‚å¸¸
RCT_EXPORT_METHOD(reportSoftException:(NSString *)message
                  stack:(NSArray<NSDictionary *> *)stack
                  exceptionId:(nonnull NSNumber *)exceptionId)
{
  // å±•ç¤º RedBox
  [_bridge.redBox showErrorMessage:message withStack:stack];

  // å¦‚æœæœ‰ delegateï¼Œè°ƒç”¨å…¶ä¸­çš„ handleSoftJSExceptionWithMessage æ–¹æ³•
  // è¿™ä¸ªé€»è¾‘æ˜¯ä¸ºäº†è®© APP å¼€å‘è€…å¯ä»¥æœ‰æœºä¼šæ„ŸçŸ¥åˆ° JS æœªå¤„ç†çš„éè‡´å‘½å¼‚å¸¸è€Œæ­å»ºçš„
  // åæ–‡ä¼šç”¨ä¸€ä¸ªä¾‹å­æ¥è®²è§£å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæœºåˆ¶
  if (_delegate) {
    [_delegate handleSoftJSExceptionWithMessage:message stack:stack exceptionId:exceptionId];
  }
}

// å¤„ç†è‡´å‘½å¼‚å¸¸
RCT_EXPORT_METHOD(reportFatalException:(NSString *)message
                  stack:(NSArray<NSDictionary *> *)stack
                  exceptionId:(nonnull NSNumber *)exceptionId)
{
  // ä¸éè‡´å‘½å¼‚å¸¸ä¸€è‡´ï¼Œå±•ç¤º RedBox
  [_bridge.redBox showErrorMessage:message withStack:stack];

  // å¦‚æœæœ‰ delegateï¼Œè°ƒç”¨å…¶ä¸­çš„ handleFatalJSExceptionWithMessage æ–¹æ³•
  // ä¸éè‡´å‘½å¼‚å¸¸ä¸€è‡´ï¼Œè¿™ä¸ªé€»è¾‘æ˜¯ä¸ºäº†è®© APP å¼€å‘è€…å¯ä»¥æœ‰æœºä¼šæ„ŸçŸ¥åˆ° JS æœªå¤„ç†çš„éè‡´å‘½å¼‚å¸¸è€Œæ­å»ºçš„
  if (_delegate) {
    [_delegate handleFatalJSExceptionWithMessage:message stack:stack exceptionId:exceptionId];
  }

  static NSUInteger reloadRetries = 0;
  // _maxReloadAttempts æ˜¯ä¸€ä¸ªå¯ä»¥è®© APP å¼€å‘è€…è‡ªå·±è®¾ç½®çš„å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ 0ï¼ˆä¹Ÿå°±æ˜¯å‘ç”Ÿè‡´å‘½å¼‚å¸¸é©¬ä¸ŠæŠ›å¼‚å¸¸ï¼‰
  // å¦‚æœè®¾ç½®ä¸º 1ï¼Œåˆ™ä¼šå…è®¸ RN reload ä¸€æ¬¡ bridgeï¼Œå¦‚æœ reload åå†å‘ç”Ÿè‡´å‘½å¼‚å¸¸ï¼Œåˆ™ä¼šç›´æ¥æŠ›å‡º
  // åæ–‡ä¼šç”¨ä¸€ä¸ªä¾‹å­æ¥ä»‹ç»å¦‚ä½•è®¾ç½®è¿™ä¸ªå€¼ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªâ€œé™¤éä½ çŸ¥é“åæœï¼Œä¸ç„¶ä¸è¦è½»æ˜“ä½¿ç”¨â€çš„æœºåˆ¶
  if (!RCT_DEBUG && reloadRetries < _maxReloadAttempts) {
    reloadRetries++;
    [_bridge reload];
  } else {
    // ç›´æ¥æŠ›å‡º IOS å±‚é¢çš„å¼‚å¸¸
    NSString *description = [@"Unhandled JS Exception: " stringByAppendingString:message];
    NSDictionary *errorInfo = @{ NSLocalizedDescriptionKey: description, RCTJSStackTraceKey: stack };
    RCTFatal([NSError errorWithDomain:RCTErrorDomain code:0 userInfo:errorInfo]);
  }
}

// è®¾ç½® _delegate çš„æ–¹æ³•ï¼Œåæ–‡ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨
- (instancetype)initWithDelegate:(id<RCTExceptionsManagerDelegate>)delegate
{
  if ((self = [self init])) {
    _delegate = delegate;
  }
  return self;
}
```

å¯ä»¥çœ‹åˆ° IOS `RCTExceptionsManager` è·Ÿ Android çš„é€»è¾‘åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºå®ƒå¤šäº†ä¸€ä¸ª delegate

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥èŠä¸€ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ª delegate

è¦è®¾ç½® delegateï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„ RN é¡¹ç›®ä¸­çš„ `AppDelegate.m`ï¼š

```objective-c
// in AppDelegate.m(your repo)

@implementation AppDelegate

- (NSURL *)sourceURLForBridge:(RCTBridge *)bridge
{
  return [[RCTBundleURLProvider sharedSettings]
          jsBundleURLForBundleRoot:@"index"
          fallbackResource:nil];
}

/**
 * âš ï¸å…³é”®éƒ¨åˆ†
 * extraModulesForBridge ä¼šè¢« RCTCxxBridge.mm ä¸­çš„ registerExtraModules æ–¹æ³•è°ƒç”¨
 * è¿™ä¸ªæ–¹æ³•ä¼šè¦†ç›–åŸæ¥ RCTExceptionsManager çš„å®ç°ï¼Œç”±äºæˆ‘ä»¬çš„å®ä¾‹å¸¦ç€ delegateï¼Œæ‰€ä»¥å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ä¼šè¢«è°ƒç”¨
 */
- (NSArray<id<RCTBridgeModule>> *)extraModulesForBridge:(RCTBridge *)bridge
{
  MyExceptionsDelegate *delegate = [MyExceptionsDelegate new];
  // åˆå§‹åŒ–è‡ªå·±çš„ RCTExceptionsManagerï¼Œå¹¶ä¸”å¸¦ä¸Šæˆ‘ä»¬è‡ªå·±çš„ delegate
  RCTExceptionsManager *manager =
    [[RCTExceptionsManager alloc] initWithDelegate:delegate];
  // è®¾ç½®å‡ºç°è‡´å‘½å¼‚å¸¸æ˜¯å…è®¸ reload bridge çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 0
  manager.maxReloadAttempts = 1;

  return @[ manager ];
}

- (BOOL)application:(UIApplication *)application
didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
  RCTBridge *bridge = [[RCTBridge alloc] initWithDelegate:self
                                           launchOptions:launchOptions];

  RCTRootView *rootView =
    [[RCTRootView alloc] initWithBridge:bridge
                             moduleName:@"Demo"
                      initialProperties:nil];

  rootView.backgroundColor = [UIColor whiteColor];

  self.window = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
  UIViewController *vc = [UIViewController new];
  vc.view = rootView;
  self.window.rootViewController = vc;
  [self.window makeKeyAndVisible];

  return YES;
}

@end
```

`AppDelegate.m` çš„æ¡†æ¶æ­å¥½äº†ï¼Œæ¥ä¸‹æ¥æ˜¯ `MyExceptionsDelegate` çš„å®ç°ï¼š

```objective-c
// in MyExceptionsDelegate.m(your repo)

@implementation MyExceptionsDelegate

- (void)handleFatalJSExceptionWithMessage:(NSString *)message
                                   stack:(NSArray<NSDictionary *> *)stack
                             exceptionId:(NSNumber *)exceptionId
{
  // å¯ä»¥æ‰“å°æ—¥å¿—ï¼Œå¯ä»¥åšåˆ†æï¼Œä¹Ÿå¯ä»¥ä¸»åŠ¨æŠ›é”™
  NSLog(@"[MyDelegate] FATAL JS ERROR: %@", message);
}

- (void)handleSoftJSExceptionWithMessage:(NSString *)message
                                  stack:(NSArray<NSDictionary *> *)stack
                            exceptionId:(NSNumber *)exceptionId
{
	// å¯ä»¥æ‰“å°æ—¥å¿—ï¼Œå¯ä»¥åšåˆ†æï¼Œä¹Ÿå¯ä»¥ä¸»åŠ¨æŠ›é”™
  NSLog(@"[MyDelegate] SOFT JS ERROR: %@", message);
}

@end
```

è‡³æ­¤ï¼Œæˆ‘ä»¬äº†è§£äº† IOS æ˜¯å¦‚ä½•å¤„ç† JS ä¼ é€’è¿‡æ¥çš„å¼‚å¸¸ï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•åœ¨è¿‡ç¨‹ä¸­ç”¨ delegate çš„æ–¹å¼è®°å½•è¿™ä¸ªå¼‚å¸¸

<br />

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœ Native module å‘ç”Ÿäº†å¼‚å¸¸è¯¥æ€ä¹ˆå¤„ç†

è·Ÿ Android ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆæ”¾ä¸€ä¸ªæµç¨‹å›¾ï¼Œç„¶åç”¨ä»£ç æ¥è§£é‡Š IOS æ˜¯å¦‚ä½•å¤„ç†çš„ï¼š

```bash
  JS è°ƒç”¨ Native module çš„æ–¹æ³•
â†’ RN æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—ï¼Œé€šè¿‡ invoke è°ƒç”¨
â†’ åœ¨ invoke æ–¹æ³•ä¸­æ‰¾åˆ°å¯¹åº”çš„ Queueï¼ˆä»£è¡¨ IOS çš„çº¿ç¨‹ï¼‰ï¼Œè°ƒç”¨ dispatch_async æ–¹æ³•åœ¨å¯¹åº”çš„ Queue æ‰§è¡Œå¯¹åº”æ–¹æ³•
â†’ åœ¨ invoke çš„å†…éƒ¨æ–¹æ³• invokeInner ä¸­ç”¨ try-catch æ•è· Native module æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸
â†’ åœ¨ catch å—ä¸­æŠŠæ•è·çš„å¼‚å¸¸äº¤ç»™ RCTFatal å¤„ç†
â†’ åœ¨ RCTFatal ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡æ³¨å†Œ RCTFatalHandler è·å¾—å¤„ç†å¼‚å¸¸çš„æœºä¼šï¼Œå¦åˆ™è¿™ä¸ªå¼‚å¸¸ä¼šè¢«å½“æˆ NSException è¢«æŠ›å‡ºï¼Œæœ€åé€ æˆåº”ç”¨é—ªé€€
```

åœ¨æœ¬ä¸“æ çš„å‰æ–‡æœ‰è¯´è¿‡ï¼ŒRN çš„ä¸åŒ Native module åœ¨ IOS ä¸­å–å†³äºå…·ä½“é…ç½®æœ‰å¯èƒ½å­˜åœ¨äºä¸åŒçš„ Queue ä¸­ï¼ˆç±»ä¼¼ Android çš„çº¿ç¨‹ï¼‰

æ‰€ä»¥ä» JS åˆ° Native module çš„è°ƒç”¨åŠ¿å¿…éœ€è¦ç»è¿‡è·¨çº¿ç¨‹çš„æµç¨‹ï¼Œå…¶ä¸­çš„ç¬¬ä¸€æ­¥å°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—ï¼Œç„¶åé€šè¿‡ invoke æ–¹æ³•è°ƒç”¨ï¼š

```cpp
// in ModuleRegistry.cpp

void ModuleRegistry::callNativeMethod(unsigned int moduleId, unsigned int methodId, folly::dynamic&& params, int callId) {
  if (moduleId >= modules_.size()) {
    throw std::runtime_error(
      folly::to<std::string>("moduleId ", moduleId, " out of range [0..", modules_.size(), ")"));
  }
  // æ‰¾åˆ°å¯¹åº”æ¨¡å—ï¼Œè°ƒç”¨æ¨¡å—çš„ invoke æ–¹æ³•
  modules_[moduleId]->invoke(methodId, std::move(params), callId);
}
```

è°ƒç”¨åä¼šè¿›å…¥è¯¥æ¨¡å—çš„ invoke æ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯å¯¹åº”å®ç°ï¼š

```objc
// RCTNativeModule.mm

void RCTNativeModule::invoke(unsigned int methodId, folly::dynamic &&params, int callId) {
  __weak RCTBridge *weakBridge = m_bridge;
  __weak RCTModuleData *weakModuleData = m_moduleData;
	// æ„å»ºéœ€è¦åœ¨å¯¹åº” Queue ä¸­æ‰§è¡Œçš„ä»£ç å—
  dispatch_block_t block = [weakBridge, weakModuleData, methodId, params=std::move(params), callId] {
    #ifdef WITH_FBSYSTRACE
    if (callId != -1) {
      fbsystrace_end_async_flow(TRACE_TAG_REACT_APPS, "native", callId);
    }
    #endif
    // è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œæ˜¯å…·ä½“æ‰§è¡Œ native module æ–¹æ³•çš„æ–¹æ³•
    invokeInner(weakBridge, weakModuleData, methodId, std::move(params));
  };

  if (m_bridge.valid) {
    // ä»è¯¥ module æ‰¾åˆ°å¯¹åº”çš„ Queue
    dispatch_queue_t queue = m_moduleData.methodQueue;
    if (queue == RCTJSThread) {
      // å¦‚æœå¯¹åº”çš„ Queue å°±æ˜¯å½“å‰çš„ Queueï¼Œç›´æ¥æ‰§è¡Œ
      block();
    } else if (queue) {
      // å¦åˆ™ä½¿ç”¨ dispatch_async è·¨çº¿ç¨‹è°ƒç”¨
      dispatch_async(queue, block);
    }
  } else {
    RCTLogWarn(@"Attempted to invoke `%u` (method ID) on `%@` (NativeModule name) with an invalid bridge.", methodId, m_moduleData.name);
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯åœ¨å¯¹åº”çš„ Queue ä¸­è°ƒç”¨äº† invokeInner æ–¹æ³•ï¼š

```objc
// RCTNativeModule.mm

static MethodCallResult invokeInner(RCTBridge *bridge, RCTModuleData *moduleData, unsigned int methodId, const folly::dynamic &params) {
  if (!bridge || !bridge.valid || !moduleData) {
    return folly::none;
  }

  // æ‰¾åˆ°éœ€è¦è°ƒç”¨çš„æ–¹æ³•
  id<RCTBridgeMethod> method = moduleData.methods[methodId];
  if (RCT_DEBUG && !method) {
    RCTLogError(@"Unknown methodID: %ud for module: %@",methodId, moduleData.name);
  }

  // æ„å»ºå‚æ•°
  NSArray *objcParams = convertFollyDynamicToId(params);
  @try {
    // è°ƒç”¨ Native module çš„æ–¹æ³•
    id result = [method invokeWithBridge:bridge module:moduleData.instance arguments:objcParams];
    return convertIdToFollyDynamic(result);
  }
  @catch (NSException *exception) {
		// å¦‚æœæ˜¯ RN å†…éƒ¨å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
    if ([exception.name hasPrefix:RCTFatalExceptionName]) {
      @throw exception;
    }

    NSString *message = [NSString stringWithFormat:@"Exception '%@' was thrown while invoking %s on target %@ with params %@\ncallstack: %@",exception, method.JSMethodName, moduleData.name, objcParams, exception.callStackSymbols];
    // å¦åˆ™äº¤ç»™ RCTFatal å¤„ç†
    RCTFatal(RCTErrorWithMessage(message));
  }
  return folly::none;
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ RCTFatal å†…éƒ¨å¹²äº†ä»€ä¹ˆï¼š

```objc
// in RCTAssert.m

void RCTFatal(NSError *error)
{
  _RCTLogNativeInternal(RCTLogLevelFatal, NULL, 0, @"%@", error.localizedDescription);

  // è·å–å¼€å‘è€…è®¾ç½®çš„ RCTFatalHandler
  RCTFatalHandler fatalHandler = RCTGetFatalHandler();
  if (fatalHandler) {
    // å¦‚æœæœ‰å°±æ‰§è¡Œ RCTFatalHandler
    fatalHandler(error);
  } else {
#if DEBUG
    @try {
#endif
      NSString *name = [NSString stringWithFormat:@"%@: %@", RCTFatalExceptionName, error.localizedDescription];
      NSString *message = RCTFormatError(error.localizedDescription, error.userInfo[RCTJSStackTraceKey], 75);
      // å¦‚æœæ²¡æœ‰ RCTFatalHandler å°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸
      @throw [[NSException alloc]  initWithName:name reason:message userInfo:nil];
#if DEBUG
    } @catch (NSException *e) {}
#endif
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº† RCTFatalHandlerï¼Œæˆ‘ä»¬å°±å¯ä»¥è¦†ç›–é»˜è®¤çš„é€»è¾‘ï¼Œæ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„å¼‚å¸¸å¤„ç†é€»è¾‘

é‚£ä¹ˆåº”è¯¥æ€ä¹ˆè®¾ç½® RCTFatalHandler å‘¢ï¼Ÿ

```objc
// in AppDelegate.m(Your repo)

#import <React/RCTAssert.h>

static void MyFatalHandler(NSError *error) {
  // æ‰“å°æ—¥å¿—ã€ä¸ŠæŠ¥å¼‚å¸¸ç­‰ç­‰
}

@implementation AppDelegate
- (BOOL)application:(UIApplication *)application
    didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
  // åœ¨è¿™é‡Œè®¾ç½® MyFatalHandler
  RCTSetFatalHandler(MyFatalHandler);

  // ...çœç•¥éƒ¨ä»½ä»£ç 
  return YES;
}
@end
```

ç®€å•ä¸€è¡Œä»£ç æå®šğŸ‘

## æ€»ç»“

åœ¨ä¸Šé¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬èŠåˆ°äº† RN æ•è· JS å¼‚å¸¸çš„æ¨¡å— `ErrorUtils` ä»¥åŠåŸç”Ÿå¹³å°æ˜¯å¦‚ä½•é€šè¿‡ `ExceptionsManager` è¿™ä¸ªæ¨¡å—å¤„ç†å¼‚å¸¸çš„

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜èŠåˆ°äº†åŸç”Ÿå¹³å°æ˜¯å¦‚ä½•æ•è·å¹¶å¤„ç†å®ƒä»¬è‡ªå·±çš„ Native Module å¼‚å¸¸

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é™¤äº†äº†è§£å¹¶åˆ©ç”¨è¿™äº› RN æä¾›çš„å¼‚å¸¸å¤„ç†æ–¹æ¡ˆä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç»“åˆåŸç”Ÿå¹³å°æœ¬èº«çš„å¼‚å¸¸å¤„ç†æœºåˆ¶æ¥ä½¿ç”¨ï¼Œæ­¤å¤–å¸‚é¢ä¸Šä¹Ÿæœ‰å¾ˆå¤šä¸“æ³¨äº APP çš„å¼‚å¸¸å¤„ç†çš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ Sentry

é‡è¦çš„æ˜¯ï¼Œè´´åˆä¸šåŠ¡å…·ä½“åœºæ™¯ï¼Œé€‰æ‹©æœ€é€‚åˆçš„å¤„ç†æ–¹æ¡ˆ

