# 数据库恢复技术

## 事务的基本概念

事务 Transaction 是用户定义的一个数据库操作序列，这些操作要不全做要不不做，是一个不可分割的工作单位，是恢复与并发控制的基本单位

### 事务与程序的区别

- 一个事务可以是一条 SQL 语句，也可以是一组 SQL 语句或者整个程序
- 一个程序通常包含多个事务

### 事务的定义

正常情况下，一个事务分为三个步骤：

1. 开始事务
2. 执行该事务的语句
3. 提交

当事务正常结束，会提交事务的所有操作（读 + 更新）

提交指的是将数据的更新写回物理磁盘中

<br />

异常情况下，一个事务分为三个步骤：

1. 开始事务
2. 执行该事务语句
3. 回滚

如果事务异常终止，将不能继续执行，系统将会对本次事务更新的部分进行撤销操作，回滚到事务发生前的状态

### 事务的特性 ACID

ACID 指的是：

- 原子性 Atomicity：事务要么全做要么全不做
- 一致性 Consistency：事务的执行结果要从一个一致性状态变到另一个一致性状态（类似纯函数）
- 隔离性 Isolation：事务之间不能相互打扰
- 持续性 Durability：当事务被提交是，它对数据的改变就是永久的了

## 数据库恢复技术概述

故障是不可避免的

故障会导致数据库运行事务非正常中断、影响数据库中数据的正确性、导致数据库部分或全部数据丢失等

数据库恢复主要作用是将数据库从错误状态恢复到某一个一致的正确状态

数据库恢复子系统是 DBMS 中的一个重要组成部分，代码量占到了整个系统的 10%，是数据库数据的最后一道防线

## 故障的种类

故障的种类分为四个部分：

- 事务内部的故障
- 系统故障
- 介质故障
- 计算机病毒

### 事务内部的故障

事务内部的故障一般是由程序构成的问题。

此类故障有些是可预期的；有些是不可预期的，不能由事务来处理的（死锁、EOM）

事务故障意味着事务没有达到预期的重点，数据库处于不正确的状态，这个时候需要**撤销事务对数据库的修改**

### 系统故障

系统故障一般是 DBMS 或者软件的故障，又被称为软故障

- 故障表现：整个系统正常运行被破坏，**内存中数据库缓冲区信息全部丢失，所有正在进行的事务非正常终止，不会破坏数据库**
- 常见原因：特定类型的硬件错误、操作系统故障、DBMS 系统代码作物、系统断电等
- 恢复方式：如果发生故障时部分数据已经写入数据库，这时需要**回滚**；如果发生故障时数据还未写到数据库中，这个时候只需要**重做已经提交的事务**

### 介质故障

介质故障代表的是硬件故障，比如磁盘损坏

- 故障表现：破坏数据库或部分数据库，影响正在存取这部分数据的所有事务；**出现概率低，但是破坏性大**

### 计算机病毒

特点：隐蔽性、潜伏性、传染性、破坏性、寄生性

如果数据库被破坏需要使用恢复技术把数据库加以恢复

## 恢复的实现技术

恢复机制的核心在于**建立冗余数据**

建立冗余数据的常用方法有：数据转储 backup、日志文件 logging

### 数据转储

数据管理员或 DBMS 定期将整个数据库复制到磁带、磁盘或其他存储介质上保存起来的过程

这些备用的数据被称为副本 backup

副本只能将数据库恢复到转储的状态，如果需要恢复到故障发生时的状态，需要重新运行转储依赖的操作日志更新数据

<br />

转储的分类：

- 静态转储：在系统无运行事务的时候进行转储，转储期间不允许对数据库进行存储、修改活动
    - 优点：简单
    - 缺点：降低数据库可用性
- 动态转储：转储操作与用户事务并发进行，转储期间允许对数据库数据存取或修改
    - 优点：转储不会影响事务的运行
    - 缺点：不能保证副本中的数据正确有效
- 海量转储：每次转储全部数据库
    - 优点：恢复方便
    - 缺点：如果数据量大，不实用
- 增量转储：只转储上次转储后更新的数据

|  | 动态转储 | 静态转储 |
| --- | --- | --- |
| 海量转储 | 动态海量转储 | 静态海量转储 |
| 增量转储 | 动态增量转储 | 静态增量转储 |

### 登记日志文件

日志文件只用来记录事务对数据库的更新操作

日志文件分为两种：

- 以记录为单位的日志文件：包含事务的开始标记、事务的结束标记、事务的更新操作
- 以块为单位的日志文件：包含事务表示、被更新的数据块

每一条日志文件包含：

- 事务标识（标记是哪一个事务）
- 操作类型（增删改）
- 操作对象（记录的内部标识）
- 更新前的旧值（插入数据的话旧值为空）
- 更新后的新值（删除操作的话新值为空）

#### 日志文件的作用

用于**事务故障恢复**与**系统故障恢复**，并协助后备副本进行**介质故障恢复**

#### 登记日志文件

为了保证数据是可恢复的，登记日志文件需要遵循两条原则：

- 登记的次序严格按照事务执行时间的吮吸
- 必须先写日志文件，后写数据库

## 恢复策略

#### 事务故障的恢复

恢复步骤：

1. 反向扫描文件日志（由最近的时间往前扫描）
2. 对事务的更新操作进行你操作，将记录更新前的值写入数据库
3. 继续反向扫描日志文件，查找其他更新事务
4. 持续 1～3，直到读到此事务的开始标记

#### 系统故障的恢复

系统故障会造成两种数据不一致：

- 未完成的事务对数据库的更新可能已经写入数据库（物理磁盘中）
- 未完成的事务还在缓冲区中，未写入数据库

相对应的由两种处理方式：

- UNDO 未完成的事务
- REDO 已完成的事务

系统故障的恢复由系统在重新启动时自动完成，**不需要用户干预**

恢复步骤：

1. 争相扫描日志文件（从头到尾扫描）
2. 对撤销队列事务进行撤销
3. 对重做队列事务今次难过重做处理

#### 介质故障的恢复

介质故障后磁盘上的物理数据与日志文件被破坏，是最严重的一种故障

恢复方法是重装数据库，然后重做一完成的任务

恢复步骤：

1. 装入最新的后备数据库副本，使得数据库恢复到最近一次转储时的一致性状态
2. 装入有关的日志文件副本，重做已完成的事务

介质故障**需要数据库管理员介入**

## 具有检查点的恢复技术

在利用日志技术恢复数据库时，恢复子系统必须搜索日志确定需要重做或撤销的事务，这个过程中：

- 搜索整个日志会耗费大量时间
- 重做会浪费大量时间

所以检查点check point 被提出来了，检查点是指我们可以**在日志文件中增加检查点记录**，**在系统中增加重新开始文件**，恢复子系统会在登录日志文件期间动态维护日志

#### 检查点记录的内容

- 建立检查点时所有正在执行的事务清淡
- 这些食物最近一个日志记录的地址
- 重新开始文件的内容（重新开始文件记录检查点记录的地址）
- 记录各个检查点在日志文件中的地址

#### 检查点如何维护日志文件

我们可以通过周期性的执行如下操作维护日志文件：

1. 建立检查点
2. 保存数据库状态

具体步骤如下：

1. 将当前日志缓冲区的所有日志记录写入磁盘的日志文件中
2. 在日志文件中写入一个检查点记录
3. 将当前的数据缓冲区中的所有记录写入磁盘数据库中
4. 把检查点记录在日志文件中的地址写入一个重新开始文件

#### 利用检查点的恢复策略

如果一个事务在检查点之前被提交，那么该事务对数据库所做的修改已经写入了数据库，这样一来在恢复的时候就不需要执行该事务了

如果一个事务在检查点之后被提交，则需要重做

恢复步骤：

1. 从重新开始文件中找到最后一个检查点记录在日志文件中的地址，由该地址找到最后一个检查点记录
2. 由该检查点记录得到检查点建立时刻正在执行的事务清单，建立 undo-list 跟 redo-list
3. 从检查点开始正向扫描日志文件，直到日志文件结束
4. 如果扫描过程中有新开始的事务，将其放到 undo-list 中；如果有提交的事务，将事务从 undo-list 移到 redo-list 中
5. 对 undo-list 执行撤销 undo 操作；对 redo-list 中的每个事务进行 redo 操作

## 数据库镜像

数据库镜像 mirror 是为了预防介质故障，提高数据可用性的一个技术手段

数据库镜像是 DBMS **自动将整个数据库或其中的关键数据复制到另一个磁盘**中的操作

如果出现介质故障时，可以**由镜像磁盘继续提供使用**，同时 **DBMS 可以自动利用镜像磁盘进行数据库的恢复**，不需要关闭系统与重装数据库副本

如果没有故障时，**可以用于并发操作**，给其他应用程序提供服务