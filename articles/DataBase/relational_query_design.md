# 关系查询处理

## 查询处理

RDBMS 的查询处理分为以下步骤：

1. 查询分析
2. 查询检查
3. 查询优化
4. 查询执行

### 查询分析

对查询语句进行扫描，进行词法分析与语法分析

- 词法分析：从查询语句中识别出正确的语言符号
- 语法分析：进行语法检查

### 查询检查

对要访问的数据句进行检查，主要包括：

- 合法性检查：根据数据字典有关模式定义检查语句中的数据库对象（如关系名，属性名是否存在与有效）
- 视图转换：如果是对视图的操作，则要用视图消解法将其转换为对基本表的操作
- 完整性与安全性的初步检查：根据数据字典中的用户权限与完整性约束定义对用户的存取权限进行检查

当这个检查通过后会把 SQL 查询语句转换成内部表示（查询树）

### 查询优化

选择一个执行的查询处理操作，包括：代数优化与物理优化

选择优化的依据依次有三个：

1. 基于规则
2. 基于代价
3. 基于语义

### 查询执行

1. 依据优化器得到的执行策略生成执行计划
2. 由代码生成器生成执行查询计划的代码
3. 执行查询计划
4. 返回查询结果

### 实现查询操作的算法

#### 选择操作

选择操作一般有两种算法实现：

- 全表扫描 Table scan：按照顺序扫描；这种方法适合小表，不适合大表
- 索引扫描 Index scan：根据选择条件属性上的索引，先找到元组指针，再通过元组指针找到元组

全表扫描的步骤：

1. 按照物理次序依次读取表到内存中（如果内存不够则读取一部分）
2. 检查内存中的每个元组，如果满足条件则返回
3. 否则重复步骤1，2

#### 连接操作

连接操作是查询处理中最好是的操作之一，这里指讨论等值连接最常用的实现算法

- 嵌套循环算法：多个循环比较多个表的值是否符合要求
- 排序-合并算法：先排序，然后多重循环判断，如果符合条件的值结束了直接 break 循环
- 索引连接算法：直接通过找索引合并
- Hash join 算法

### 总结

![db-5](https://raw.githubusercontent.com/Joyee691/image-hosting/main/blog/db-5.png)