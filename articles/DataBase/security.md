# 数据库安全性

## 概述

数据库的一大特点是可以进行数据共享，数据共享必然会带来安全性问题，因为共享的数据并不是无条件的

数据库安全性指的是**保护数据库以防止不合法使用造成的数据暴露、更改或破坏**

### 造成数据库不安全因素

- 非授权用户对束裤裤的恶意存取和破坏：这种防范措施主要有**用户身份鉴别**、**存取控制和视图**等
- 数据库中重要或铭感的数据被泄漏：主要防范措施有强制存取控制、**数据加密存储**与**加密传输**等
- 安全环境的脆弱性：包含计算机硬件，操作系统，网络系统的安全性。计算机安全方面需要建立一套可信trusted 的标准

## 数据库安全性控制

### 非法使用数据库的情况

- 编写合法程序绕过 DBMS 及其授权机制
- 直接或编写应用个程序执行非授权操作
- 同u狗多次合法查询从中推倒出一些保密数据

### 计算机系统的安全模型

计算机的安全措施是一级一级层层设置，具体层级如下：

- 用户：最上层。提供用户标识与鉴别
- DBMS：第二层。提供数据库安全保护
- OS：第三层。操作系统安全保护
- DB：最底层。数据密码存储

### 数据库有关的安全性

包括：用户身份验证（密码、指纹等）、多层存取控制（不同权限、不同标签等）、审计、视图、数据加密等

![db-2](https://raw.githubusercontent.com/Joyee691/image-hosting/main/blog/db-2.png)

根据上图，存取控制流程如下：

1. DBMS 对提出 SQL 访问请求的数据库用户进行身份鉴别，防止不可信用户使用系统
2. 在 SQL 处理层进行**自主存取控制**和**强制存取控制**，进一步可以进行推理控制
3. 对用户访问行为与系统关键操作进行审计，对异常用户行为进行简单入侵检测

### 用户身份鉴别

用户身份鉴别 Identification & Authentication 指的是每个用户在系统中都有一个**用户标识**，每次用户要求进入系统时由系统核对，通过鉴定后提供 DBMS 的使用权限。它是系统提供的最外层安全保护措施

用户标识一般由**用户名**与**用户标识号**组成，其中用户标识号在系统的整个生命周期中是唯一的

<br />

用户身份鉴别的方法有：

- 静态口令鉴别：一般由用户自己设定，比如登入密码
- 动态口令鉴别：口令是动态变化的，每次鉴别时均需要使用动态产生的新口令登录
- 生物特征鉴别：通过生物特征进行认证，比如指纹、虹膜等
- 智能卡鉴别：智能卡是一种不可复制的硬件，内置继承电路的芯片具有硬件加密的功能

### 存取控制

存取控制机制是由**用户权限定义**与**合法权检查机制**一起组成的

- 用户权限定义指的是将用户权限等级到数据字典中，表示用户对某一数据对象的操作权利
- 合法权限检测指的是当用户发出 SQL 请求时，DBMS 会查找数据字典进行合法权限检查

<br />

常用的存取控制方法：

- **自主存取控制** Discretionary Access Control, DAC：同一用户对不同的数据对象有不同的存取权限；不同用户对同一数据对象有不同的存取权限；用户可以将其拥有的存取权限转授给其他用户；**是一种对用户存取权限的控制**
- **强制存取控制** Mandatory Access Control, MAC：给每一个数据对象标记**密级**，每个用户被授予某一个级别的许可证，对于任意的一个对象，只有持有对应许可证用户才能访问；**是一种对数据存取权限的控制**

### 授权：授予与回收

在 SQL 中，通过 GRANT 实现权限的授予；通过 REVOKE 实现权限的收回

#### GRANT

目的：对指定操作对象的指定操作权限授予指定的用户

格式：
```sql
GRANT <auth> [, <auth>]...
	ON <ObjectType> <ObjectName> [, <ObjectType> <ObjectName>]...
	TO <User> [, <User>]...
	[WITH GRANT OPTION]
```

说明：

- 发出 GRANT 的用户可以是数据库管理员、数据库对象创建者（即 owner）、拥有该权限的用户
- 接收权限的用户可以是一个或多个具体用户、PUBLIC（全体用户）
- with grant option：如果有，则表示该权限可以再授予他人；否则则不可授予他人
- SQL 不允许循环授权

例子：把查询 Student 表的权限授予用户 U1

```sql
GRANT SELECT ON TABLE Student TO U1
```

例子：把查询 Student 表和修改学生学号的权限授予用户 U2

```sql
// 对属性列授权需要明确写出对应的属性列名
GRANT UPDATE(Sno), SELECT ON TABLE Student TO U2
```

#### REVOKE

目的：将授予的权限收回，这个操作可以由数据库管理员或其他授权者使用

格式：

```sql
REVOKE <auth> [, <auth>]...
	ON <ObjectType> <ObjectName> [, <ObjectType> <ObjectName>]...
	FROM <User> [, <User>]...
	[CASCADE | RESTRICT]
```

说明：

- 如果在授权时使用了 with grant option，则需要使用 CASCADE 才能将其权限收回，表示将其授予其他用户的权限也一并收回

例子：收回用户 U2 修改学生学号的权限

```sql
REVOKE UPDATE(Sno) ON TABLE Student FROM U2
```

#### 总结

下面依照身份来总结一下用户权限的授予与收回

数据库管理员：

- 拥有所有对象的所有权限
- 需要依据不同情况授予权限给不同用户

数据库用户：

- 拥有自己建立的对象的所有操作权限
- 可以使用 GRANT 将权限授予给其他用户

被授权的用户：

- 如果被授权的用户有 with grant option，则可以将其授权给其他用户

注意：所有将权限授权出去的用户都可以使用 REVOKE 收回权限

#### 创建数据库模式的权限

数据库管理员在**创建用户**时实现**对创建数据库模式的权限**

创建用户格式：

```sql
CREATE USER <username> [WITH] [DBA | RESOURCE | CONNECT]
```

说明：

- 只用系统的超级用户 DBA 才有权利创建一个新的数据库用户
- 新创建的用户一般会有三种权限：connect, resource, dba。
    - 默认为 connect，拥有此权限的用户不能创建新用户，不能创建模式与基本表，**只能登录数据库**
    - 拥有 resource 权限的用户**可以创建表和视图**，成为其创建对象的 owner，但是不能创建模式与新的用户
    - 拥有 dba 的权限可以创建新用户、创建模式、创建基本表和视图；dba 拥有所有对象的存取权限，还能将其授予其他用户

| 用户类型 | CREATE USER | CREATE SCHEMA | CREATE TABLE | 数据查询与操作 |
| --- | --- | --- | --- | --- |
| dba | Y | Y | Y | Y |
| resource | N | N | Y | Y |
| connect | N | N | N | Y（需要拥有相应权限） |

### 数据库角色

数据库角色值的事被命名的一组与数据库操作相关的权限，**角色是权限的集合**

可以为一组具有相同权限的用户创建一个角色，简化授权的过程

格式：

```sql
// 角色创建
GREATE ROLE <roleName>

// 角色授权
GRANT <auth> [, <auth>]...
	ON <ObjectType> <ObjectName>
	TO <roleName> [, <roleName>]...

// 将角色授予其他角色或用户
GRANT <roleName1> [, <roleName2>]...
	TO <roleName3> [, <User1>]...
	[WITH GRANT OPTION]

// 角色权限收回
REVOKE <auth> [, <auth>]...
	ON <ObjectType> <ObjectName>
	FROM <roleName> [, <roleName>]...
```

例子：

```sql
// 创建角色 R1
CREATE ROLE R1

// 给 R1 Student 表的 update 权限
GRANT UPDATE ON TABLE Student TO R1

// 将角色授予 wang，zhao
GRANT R1 TO wang,zhao

// 收回 wang 的权限
REVOKE R1 FROM wang
```

### 强制存取控制方法 MAC

自主存取控制主要是对**数据的存储权限**进行控制

强制存取控制方法主要是**对数据本身进行控制**

MAC 中的实体分为两类：

- 主体：代表系统中的活动实体。包括实际用户和代表各个用户的进程
- 客体：代表系统中的被动实体。包括文件、基本表、索引、视图

补充说明：

- MAC 是对数据本身进行密级标记，无论数据如何赋值，标记与数据都不可以被分隔，只有符合标记要求的用户才可以操纵数据
- 实现 MAC 时需要首先实现 DAC，只有 DAC 校验通过才会进入 MAC 校验的过程
- MAC 与 DAC 共同构成数据库管理系统的安全机制

#### 敏感度标记

对于主体和客体，DBMS 会为每一个实例（数据）指派一个敏感度标记

敏感度标记分成几个级别：

- 绝密 Top secret, TS
- 机密 Secret, S
- 可信Confidential, C
- 公开 Public, P

根据保密级别高到低，可以排序为：TS > S > C > P

主体的敏感度标记被称为**许可证级别 Clearance Level**

客体的敏感度标记称为**密级 Classification Level**

#### MAC  的规则

1. 只有当主体的许可证级别大于或等于客体的密级时，该主体才能读取相对应的客体
2. 只有当主体的许可证级别小于或等于客体的密级时，该主体才能写相应的客体

## 视图机制

视图对于数据库安全的作用：

- 视图可以将保密的数据对无权存取的用户隐藏起来，对数据提供了一定程度的安全保护
- 视图间接的支持存取谓词的用户权限定义

例子：

```sql
// 根据表的一部分数据建立视图
CREATE VIEW CS_Student AS SELECT * FROM Student WHERE Sdept='CS'

// 把该视图的 SELECT 权限授予 wang
GRANT SELECT ON CS_Student TO wang

// 将该视图的所有权限授予给 zhang
GRANT ALL PRIVILIGES ON CS_Student TO zhang
```

## 审计

只有特别高级别的数据库才会需要审计功能，因为审计功能需要耗费大量计算机资源

审计的作用在于**将所有对数据库的操作都记录下来**，记录的地方被称为审计日志（audit log）

一旦有了审计日志，**审计员就可以利用审计日志监控数据库中的所有行为**，找出非法存取数据的人、时间、以及内容

#### 审计事件

审计日志中记录的事件如下：

- 服务器事件：包含审计数据库服务器发生的事件
- 系统权限：对系统拥有的结构或模式对象进行操作的审计，对该操作的权限时通过系统权限获得的
- 语句事件：对 SQL 语句进行审计
- 模式对象事件：对特定模式对象上进行的查询，操作进行审计

#### 审计功能

审计一般有五个功能：

- 基本功能：提供多种审计的查阅方式
- 多套审计规则：在初始化时可以设定多套审计过则
- 提供审计分析以及审计报表的功能
- 审计日志管理功能：防止误删除、对转储的审计记录提供完整性和保密性保护、只允许审计员查阅和转储审计记录，防止其他用户修改审计记录
- 提供审计设置及审计记录信息的专门视图

#### 审计分类

审计分为**用户级审计**和**系统级审计**：

- 用户级审计：任何用户都可以设置的审计，主要是用户针对自己设置的数据库表和视图进行审计
- 系统级审计：只能有数据库管理员设置，可以检测数据库所有操作，比如用户成功或失败的登入请求、数据库授权和收回操作以及数据库权限下的操作

#### 审计的设置

审计可以使用 AUDIT 设置审计功能，使用 NOAUDIT 取消审计功能

例子：

```sql
// 对 SC 表的结果或者表数据的操作进行审计
AUDIT ALTER UPDATE ON SC

// 取消对 SC 表的审计
NOAUDIT ALTER, UPDATE ON SC
```

说明：

- 审计的设置与审计日志一般存储在数据字典中
- 必须打开审计开关（系统参数 audit_trail 设置为 true），才能在系统表 SYS_SUDITTRAIL 中看到审计信息
- 数据库安全审计系统提供一种时候检查的安全机制

## 数据加密

数据加密主要防止数据库中数据在存储和传输过程中失密的有效手段

数据加密包括**存储加密**与**传输加密**

#### 存储加密

存储加密分为两种：

- 透明存储加密：
    - 是内核级别的加密保护方式，对用户完全透明，性能较好，安全完备性较高
    - 通过将数据写到磁盘时进行加密，当授权用户读取数据时对其解密
    - 数据库的应用程序不需要做任何修改，只需要在创建表格语句中说明需要加密的字段就好
- 非透明存储加密：通过多个jia mi han s

#### 传输加密

传输加密分为两种：

- 链路加密：
    - 在计算机网络的链路层进行加密
    - 传输信息由报头与报文两个部分组成，报文和报头均加密
- 端到端加密：
    - 在发送端加密，在接受端解密
    - 只加密保温杯不加密报头
    - 所需密码设备数量相对较少，容易被非法监听者发现并从中获取敏感信息

## 其他安全性措施

- 推理控制：防止用公开信息推理出保密信息
- 隐蔽信道：防止用正常信息传输线路传输保密信息
- 数据隐私保护：防止他人获取个人不想让他人知道的信息，主要用于数据收集储存处理和数据发布等阶段